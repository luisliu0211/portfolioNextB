# å»ºç«‹ä¼ºæœå™¨ simple web å‰å¾Œç«¯äº’å‹•

collection: backend
tags: express.js, nodejs

---

### ç°¡æ˜“ä¼ºæœå™¨å»ºç«‹

<aside>
â˜ğŸ» åœ¨node ç’°å¢ƒ å»ºç«‹server.js  é™½æ˜¥ï¼åƒ…èƒ½æ¥æ”¶è«‹æ±‚å›å¾©

[iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©](https://ithelp.ithome.com.tw/m/articles/10272180)

```jsx
const http = require('http'); // å¼•å…¥nodeå…§å»ºå¥—ä»¶ http
const port = 3002; //è¨­å®šæ¥å£
const fs = require('fs/promises'); //å¼•å…¥ npm i fs/promises è®€å–æª”æ¡ˆ

// å»ºç«‹ä¼ºæœå™¨è™•ç†ç”¨æˆ¶ç«¯ç™¼å‡ºhttpè«‹æ±‚ æ”¶åˆ°è«‹æ±‚å¾Œ å›å¾©å°æ‡‰çš„ç¶²é å…§å®¹

const server = http.createServer(async (request, response) => {
  // å»ºç«‹ä¼ºæœå™¨ï¼š è™•ç†req/ res      
```

### è¨­å®šresponse å›å‚³httpçš„æ¨™é ­(é ­éƒ¨è¨Šæ¯)

å¯ä»¥é€é`setHeader`æˆ–æ˜¯`writeHead`

å‰è€…åªèƒ½è¨­response headerå–®å€‹å±¬æ€§å…§å®¹;å¾Œè€…å¯ä»¥ä¸€æ¬¡è¨­ç½®æ‰€æœ‰çš„ç‹€æ…‹ç¢¼ã€éŸ¿æ‡‰é ­ã€ç‹€æ…‹è³‡è¨Šã€‚

```jsx
writeHead(statusCode,[, StatusMessage[, headers]]);

response.writeHead(200,//ç‹€æ…‹ç¢¼
  {'Content-Lenghth':'Buffer.byteLenght(body)',//å‘ŠçŸ¥ç€è¦½å™¨ç™¼é€çš„æ•¸æ“šé¡å‹
  'Content-Type':'text/html;charset=UTF-8'});//å…·é«”æœƒå¦‚ä½•é¡¯ç¤ºæ•¸æ“š
```

### è£œå……ï¼š

### **1.ä»£è¡¨å¯ä»¥è­˜åˆ¥HTMLçš„çµæ§‹ï¼Œä¸¦ä½¿ç”¨UFT-8ç·¨ç¢¼åˆ†æã€‚**

```
'Content-Type':'text/html;charset=UTF-8'

```

### **3.ä»£è¡¨è¨­ç½®åœ–ç‰‡çµæ§‹(png/jpg)ã€‚**

```
'Content-Type':'image/png'
'Content-Type':'image/jpg'
```

### **2.ä»£è¡¨è¨­ç½®æˆç´”æ–‡æœ¬çš„çµæ§‹ï¼Œä¸¦ä¸å¯è­˜åˆ¥Htmlçš„çµæ§‹ã€‚**

```
'Content-Type':'text/plain'

```

[Nodeä¸­setHeaderå’ŒwriteHeadçš„åŒºåˆ«](https://juejin.cn/post/7077951590157516837)

### å›å‚³responesçš„å…§å®¹

å¯ä»¥ä¸åªæ˜¯æ–‡å­—,å¯èƒ½æ˜¯html, jsonâ€¦â€¦

åœ¨æ¯å€‹HTTPè«‹æ±‚çš„æœ€å¾Œéƒ½æœƒèª¿ç”¨endæ–¹æ³•ï¼Œå°±æ˜¯çµæŸéŸ¿æ‡‰ï¼Œç•¶å®¢æˆ¶ç«¯è«‹æ±‚å®Œæˆå¾Œï¼Œéƒ½æœƒè¢«èª¿ç”¨åŸ·è¡Œã€‚

> å¦‚æœä¸èª¿ç”¨endçš„è©±ï¼Œå®¢æˆ¶ç«¯å°±æœƒä¸€ç›´ç­‰å¾…ï¼Œå°±åƒåœ¨ä½¿ç”¨ç€è¦½å™¨æ™‚ï¼Œç¶²é ä¸€ç›´æ²’è·‘å®Œçš„æ¨£å¼
> 

```jsx
//é‚è¼¯ä¸Šä¾†èªªç”¨swtich æŠ“å–è’é›†åˆ°çš„request http ç¶²å€ å›è¦†å°æ‡‰çš„respones http
//å›å‚³å…§å®¹ response.end(â€™ å¯ä»¥æ˜¯æ–‡å­— å¯ä»¥æ˜¯æª”æ¡ˆâ€™)
switch (request.url) {
    case '/':
      response.end('é¦–é ');
      break;
    case '/test':
      const content = await fs.readFile('test.html');
      // ä½¿ç”¨fs/promises è®€å–æŒ‡å®šhtmlæª”æ¡ˆ
      response.end(content);
      break;
    default:
      response.writeHead(404);
      response.end('Not Found');
  }
});
```

### åŸ·è¡Œç›£è½

serverç‰©ä»¶ï¼Œå‘¼å« listen()ï¼Œå®ƒæœƒåœ¨createServer()åŸ·è¡Œæ™‚ï¼Œè®“ä½ æ±ºå®šè¦ç›£è½å“ªä¸€å€‹portï¼Œä¸¦ä¸”é–‹å§‹ç›£è½ä»»ä½•é€²ä¾†çš„requests

```jsx
server.listen(port, () => {
  console.log(`Server running at port ${port}`);
});
// ç¬¬äºŒå€‹åƒæ•¸åˆ©ç”¨callback å‡½å¼ å°å‡ºç›®å‰æ­£åœ¨åŸ·è¡Œå“ªå€‹port
```

> åŸ·è¡Œnode server.js å¾Œ ä¼ºæœå™¨æœƒä¸€ç›´ç¶­æŒåŸ·è¡Œç‹€æ…‹ è‹¥æœ‰æ›´å‹•å…§å®¹éœ€è¦åœ¨é‡æ–°åŸ·è¡Œ server.js æª”æ¡ˆ
> 
> 
> æ‰æœƒé‡æ–°å°‡è³‡æ–™å¯«å…¥è¨˜æ†¶é«” å¦å‰‡åƒ…åªæ˜¯å­˜å…¥åœ¨ç¡¬ç¢Ÿå…§å°šæœªæ›´æ–°
> 

### ä½¿ç”¨ nodemon å¥—ä»¶

npm i -g nodemon å®‰è£å…¨åŸŸ 

```
æŒ‡ä»¤ nodemon server.js å¯ä»¥ç›£è½è·¯å¾‘åº•ä¸‹æ‰€æœ‰æª”æ¡ˆè‹¥æœ‰æ”¹è®Š,è‡ªå‹•é‡æ–°å•Ÿå‹•
```

[Day7 - Node.js å…§å»ºçš„ Web Server ä»‹ç´¹åŠä½¿ç”¨ - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©](https://ithelp.ithome.com.tw/articles/10185302)

</aside>

### ç¾ä»£åšæ³• ä½¿ç”¨express å¥—ä»¶ ä¸­é–“ä»¶çš„ä¸–ç•Œï¼

express æ˜¯ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼Œæ‰€ä»¥è¦å…ˆå®‰è£ 

```jsx
const express = require('express'); // å¼•å…¥å¤–éƒ¨å¥—ä»¶ express

require('dotenv').config(); // =>ä¿è­·æ©Ÿæ•æ–‡ä»¶

// åˆ©ç”¨express é€™å€‹æ¡†æ¶/ å‡½å¼åº« å»ºç«‹ä¸€å€‹ web application
const app = express(); // å‘¼å«express å‡½å¼
const port = process.env.SERVER_PORT;

// app.[method]
// method: get/ post/ delete/ put/ patch...
app.get('/', (req, res) => {
  res.send('hello express');
}); // ç•¶ç¶²å€ç¬¦åˆæŒ‡å®šï¼ˆç¬¬ä¸€å€‹åƒæ•¸,åŸ·è¡Œcallbackä¸€å®šæœƒæœ‰req/res)

app.listen(port, () => {
  console.log(`server start at ${port} by express `);
});
```

### ä¸­é–“ä»¶middleware

> express ä¸–ç•Œå¹¾ä¹æ‰€æœ‰æ±è¥¿éƒ½æ˜¯ä¸­é–“ä»¶ â‡’ expressæ˜¯ç”±ä¸­é–“ä»¶çµ„æˆçš„
> 

**ä¸­é–“ä»¶çš„é †åºå¾ˆé‡è¦**

Express æ˜¯æŒ‰ç…§ä½ å®‰æ’çš„é †åºå»åŸ·è¡Œçš„ -> æŒ‰ç…§é †åºæ±ºå®šèª°æ˜¯ nextmiddleware æœ‰å…©ç¨®çµæœ:

- next: å¾€ä¸‹ä¸€å€‹ä¸­é–“ä»¶å»
- response: çµæŸé€™æ¬¡çš„æ—…ç¨‹ req-res cycle

```jsx
// è·¯ç”±ä¸­é–“ä»¶
app.get('/', (req, res, next) => {
res.send('hello express');
  console.log('é€™è£¡æ˜¯é¦–é ');
});

app.use((req, res , **next**) => {
console.log('é€™æ˜¯ä¸­é–“ä»¶');
next();
});
// ä¸€èˆ¬ä¸­é–“ä»¶
```

<aside>
ğŸ”¥ **res.send/ res.render/ res.json å·®ç•° éŸ¿æ‡‰æ–¹æ³•ï¼š**

| https://expressjs.com/zh-tw/4x/api.html#res.download | æç¤ºæ‚¨æä¾›è¦ä¸‹è¼‰çš„æª”æ¡ˆã€‚ |  |
| --- | --- | --- |
| https://expressjs.com/zh-tw/4x/api.html#res.end | çµæŸå›æ‡‰ç¨‹åºã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.json | å‚³é€ JSON å›æ‡‰ã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.jsonp | å‚³é€ JSON å›æ‡‰ï¼Œä¸¦æ”¯æ´ JSONPã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.redirect | å°‡è¦æ±‚é‡æ–°å°å‘ã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.render | å‘ˆç¾è¦–åœ–ç¯„æœ¬ã€‚ | è‹¥app.get() è·¯ç”±ä¸­é–“ä»¶æœ‰å¯«ç¬¬ä¸‰å€‹åƒæ•¸next(),å‰‡ä¸æœƒçµ‚æ­¢å¾ªç’° |
| https://expressjs.com/zh-tw/4x/api.html#res.send | å‚³é€å„ç¨®é¡å‹çš„å›æ‡‰ã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.sendFile | ä»¥å…«ä½å…ƒçµ„ä¸²æµå½¢å¼å‚³é€æª”æ¡ˆã€‚ |  |
| https://expressjs.com/zh-tw/4x/api.html#res.sendStatus | è¨­å®šå›æ‡‰ç‹€æ…‹ç¢¼ï¼Œä¸¦ä»¥å›æ‡‰å…§æ–‡å½¢å¼å‚³é€å…¶å­—ä¸²è¡¨ç¤ºæ³•ã€‚ |  |
</aside>

æŒ‡å¾ç™¼å‡ºè«‹æ±‚(Request)ä¹‹å¾Œï¼Œåˆ°æ¥æ”¶å›æ‡‰(Response)é€™æ®µä¾†å›çš„é€”å¾‘ä¸Šï¼Œç”¨ä¾†è™•ç†ç‰¹å®šç”¨é€”çš„ç¨‹å¼ã€‚

```jsx
// app.[method]
// method: get/ post/ delete/ put/ patch...
app.use((req, res, next) => {
  console.log('ç¬¬1å€‹ä¸­é–“ä»¶');
  // ä¸€å®šè¦å¯« next è®“express çŸ¥é“è¦è·³å»ä¸‹ä¸€å€‹ä¸­é–“ä»¶ å¦å‰‡æœƒä¸€ç›´è½‰åœˆåœˆ
  next();
});

app.get('/', (req, res, next) => {
  res.send('hello express');
  console.log('é€™è£¡æ˜¯é¦–é ');
}); 
// ç•¶ç¶²å€ç¬¦åˆæŒ‡å®šï¼ˆç¬¬ä¸€å€‹åƒæ•¸,åŸ·è¡Œcallbackä¸€å®šæœƒæœ‰req/res)
// åªè¦æœ‰response å°±çµæŸäº†ä¸èƒ½å†è¦†å¯«

app.use((req, res, next) => {
  console.log('ç¬¬2å€‹ä¸­é–“ä»¶');
  next();
});

// å¾Œé¢å¦‚æœæ²’æœ‰ä¸­é–“ä»¶å°±çµæŸå›å‚³responseçš„è³‡è¨Š
**// Express æœƒæŒ‰ç…§ä½ ç¨‹å¼ç¢¼çš„é †åº(ç”±ä¸Šåˆ°ä¸‹)å»æ±ºå®š next æ˜¯èª°
// ä¸­é–“ä»¶è£¡ä¸€å®šè¦æœ‰ next æˆ–è€… response
// - next() å¾€ä¸‹ä¸€é—œèµ°
// - res.xxx çµæŸé€™æ¬¡çš„æ—…ç¨‹ (req-res cycle)
// - res.send('')
// - res.render('')
// - res.json('')**
```

<aside>
â˜ğŸ» ä½¿ç”¨æ–¹æ³•ï¼šapp.use/ app.[method]

</aside>

### ä¸­é–“ä»¶è£¡çš„å¯ä»¥åŸ·è¡Œçš„å·¥ä½œ:

- åŸ·è¡Œä»»ä½•ç¨‹å¼ç¢¼
- æ”¹è®Š request è·Ÿ response ç‰©ä»¶ (TBA)
- çµæŸ req-res cycle â†’ å¯«res.xxxçµæŸ åƒæ•¸å¯ä¸å¯«next
- å‘¼å«ä¸‹ä¸€å€‹ middleware â†’å¯«next()

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled.png)

### middlewareåˆ†é¡

æ¯”è¼ƒå¸¸è¦‹çš„**Middleware**æœ‰èº«ä»½é©—è­‰(Identity)ã€è·¯ç”±(Routing)æˆ–å›æ‡‰å£“ç¸®(Response Compression)ç­‰ã€‚

<aside>
ğŸ”¥ ä¸­é–“ä»¶åˆ†é¡ï¼š

1. **Application-level middleware (ä¸€èˆ¬ä¸­é–“ä»¶)**
    
    *å¯ä»¥è¢«è¨­å®šå»è™•ç†æ¯ä¸€å€‹æ‡‰ç”¨ç¨‹å¼æ¥æ”¶åˆ°çš„è«‹æ±‚å…§å®¹ï¼Œå¦‚åŒå‰é¢çš„æ‡‰ç”¨ç¨‹å¼å¯¦ä½œï¼Œç•¶ä¸­æ‰€ä½¿ç”¨çš„ app.use() ã€app.get() ã€app.post() ç­‰ç­‰ï¼Œéƒ½æ˜¯ application-level middlewareçš„ä»£è¡¨ã€‚*
    
    ```jsx
    // ä½¿ç”¨ method-override
    app.use(methodOverride('_method'))
    // æŸ¥è©¢ä¸€å¼µ picture çš„è©³ç´°è³‡æ–™
    app.get('/pictures/:id', (req, res) => {
    })
    ```
    
2. **Router-level middleware (è·¯ç”±ä¸­é–“ä»¶)**
    
    *Router-level middleware æ˜¯å±¬æ–¼ express.Router() çš„å¯¦ä¾‹è®Šæ•¸ (instance)çš„ middlewareï¼Œä½¿ç”¨æ–¹æ³•è·Ÿ application-level middleware ä¸€æ¨£ï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š*
    
    ```jsx
    // å®£å‘Šä¸€å€‹åç‚º router çš„ express.Router() çš„å¯¦é«”
    const router = express.Router()   // ç•¶è«‹æ±‚çš„è·¯ç”±æ˜¯ GET /todos/:id æ™‚ï¼ŒåŸ·è¡Œ Router middleware
    router.get('/todos/:id', (req, res) => {
      // æŸ¥è©¢ä¸€å€‹ todo çš„è©³ç´°è³‡æ–™
    })
    ```
    
3. **Error-handling middleware (è™•ç†éŒ¯èª¤ä¸­é–“ä»¶)**
    
    *å°ˆé–€ä¾†è™•ç†éŒ¯èª¤ç‹€æ³çš„ middlewareï¼Œè€Œ Express çš„æ…£ä¾‹æ˜¯ç•¶ä¸€å€‹ middleware æœ‰å››å€‹åƒæ•¸æ™‚ï¼Œå°±ä»£è¡¨å®ƒæ˜¯ä¸€å€‹ error-handling middlewareï¼Œæ‰€ä»¥æ’°å¯« error-handling middleware æ™‚å¿…é ˆæä¾›å››å€‹åƒæ•¸ï¼Œåˆ†åˆ¥ç‚º errã€reqã€res èˆ‡ nextã€‚*
    
    ```jsx
    app.use(function (err, req, res, next) {
      console.error(err.stack)
      res.status(500).send('Something broke!')
    })
    ```
    
4. **Built-in middleware (å…§å»º)**
    
    *Express ç•¶ä¸­æœ‰å¹¾å€‹å…§å»ºçš„ middlewareï¼Œå¹«åŠ©æˆ‘å€‘è™•ç†ä¸€äº›ç°¡å–®çš„äº‹æƒ…ï¼Œå¦‚åŒï¼Œé€é express.static(â€˜publicâ€™) å¯ä»¥è®€å–ï¼Œç”±æˆ‘å€‘è‡ªè¡Œå»ºç«‹çš„éœæ…‹æª”æ¡ˆï¼ŒåŒ…å« JavaScript ã€ CSS æª”æ¡ˆã€‚*
    
    ```jsx
    app.use(express.static('public'))
    ```
    
5. **Third-party middleware (ç¬¬ä¸‰æ–¹ä¸­é–“ä»¶)**
    
    *Third-party middlewareï¼Œå‰‡æ˜¯ç”±ç¬¬ä¸‰æ–¹æ‰€æ’°å¯«çš„å¥—ä»¶ï¼Œå®ƒéœ€è¦é€é npm ä¸‹è¼‰ä½¿ç”¨ï¼Œè€Œ Third-party middleware æœ€å¤§çš„å¥½è™•ï¼Œå°±æ˜¯é¿å…è®“æˆ‘å€‘é‡è¤‡é€ è¼ªå­ï¼Œå¯ä»¥ç›´æ¥å¼•ç”¨ä»–äººçš„æ¨¡çµ„å·¥å…·ä¾†è§£æ±ºè‡ªèº«çš„å°ˆæ¡ˆå•é¡Œï¼Œå¦‚åŒ body-parser ã€‚*
    
    ```jsx
    // è¼‰å…¥ body-parser
    const bodyParser = require('body-parser')
    // ä½¿ç”¨ body-parser
    app.use(bodyParser.urlencoded({ 
       extended: true 
    }))
    ```
    
</aside>

<aside>
ğŸ”¥ è£œå……: pug HTML å¥—ä»¶

[ç²¾é€š Pug æ¨£ç‰ˆèªè¨€ï¼ˆä¸€ï¼‰èªæ³•åŸºç¤ç¯‡ | Blog - ç™½èŠ±æ®¿](https://www.shirohana.me/blog/articles/2020-mastery-pug-template-engine/)

HTML çš„æ¨£æ¿èªæ³•ï¼Œhtml ä¸èªå¾—ï¼Œéœ€è¦ç¶“éç·¨è­¯

- å¯åŠ é€Ÿ html çš„é–‹ç™¼
- æœ‰å¾©ç”¨èˆ‡æ“´å±•æ©Ÿåˆ¶
- å¯ä»¥å¯« loop è¿´åœˆèˆ‡ if-else åˆ¤æ–·å¼
- ç·¨è­¯æ™‚ï¼Œå¯ä»¥å¹«å¿™æª¢æŸ¥èªæ³•æ˜¯å¦æ­£ç¢º
- å–®ç¨ä½¿ç”¨
    
    ```
    # å®‰è£åœ¨å…¨åŸŸå³å¯ï¼Œè·¨å°ˆæ¡ˆå…±ç”¨
    npm install -g pug-cli
    
    # åŸå§‹ç¢¼(pug æª”) æ”¾åœ¨ src æª”æ¡ˆå¤¾è£¡ï¼Œç·¨è­¯å®Œæˆçš„ html æ”¾åœ¨ src æª”æ¡ˆå¤¾è£¡
    pug src/* -o dist
    
    ```
    
- è·Ÿ Express ä¸€èµ·ä½¿ç”¨
    
    è¦åœ¨ express å°ˆæ¡ˆè£¡å®‰è£
    
    > npm i pug
    > 
    
    ```jsx
    // è¨­å®š express è¦ç”¨çš„æ¨£ç‰ˆå¼•æ“(template engine)
    // è¨­å®šè¦–åœ–æª”æ¡ˆè¦æ”¾åœ¨å“ªè£¡
    app.set('views', path.join(__dirname, 'views'));
    // è¦ç”¨å“ªä¸€ç¨® template engine
    // npm i pug
    app.set('view engine', 'pug');
    
    app.get('/ssr', (req, res, next) => {
      // ç”¨ view engine ä¾†æ¸²æŸ“ä¸€å€‹é é¢
      // é€™å€‹ SSR (server-side render)
      // æœƒå» views è¨­å®šçš„æª”æ¡ˆå¤¾è£¡æ‰¾ ssr.pug
      // ä¸¦ä¸”æŠŠè®Šæ•¸ stocks å‚³çµ¦ pug å»æ¸²æŸ“
      res.render('index', {
        stocks: ['å°ç©é›»', 'é•·æ¦®', 'è¯ç™¼ç§‘'],
      });
    });
    
    ```
    
- ä½¿ç”¨èªæ³•ï¼š
    
    
    ä½¿ç”¨ç¯„ä¾‹ï¼š(master.pug)
    
    ```jsx
    //- master.pug
    doctype html
    html
      head
        title MFEE
        meta(charset='utf-8') //(å±¬æ€§å€¼)
    
      body
        //-head.pug (å¼•å…¥åŒå±¤head.pug)
        include head
        #content //(# ->id="content")
          block content
        //-footer.pug (å¼•å…¥åŒå±¤footer.pug)
        include footer
    ```
    
    è¼¸å‡ºä¸»æª”ç¯„ä¾‹:  index.pug
    
    ```jsx
    extends _layouts/master 
    (å°‡srcè£¡é¢çš„ä¸»æª”masteråŒ¯å…¥)
    
    block content
      h2 é€™è£¡æ˜¯é¦–é 
      table
        tr
          td col1
          td col2
        tr
          td col3
          td col4
    ```
    
    ### è³‡æ–™å¤¾çµæ§‹
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%201.png)
    
    ç·¨è­¯å¾Œæ¨£å¼ï¼š
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%202.png)
    
    ç·¨è­¯å¾Œæ¨£å¼ï¼š
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%203.png)
    
    [ç²¾é€š Pug æ¨£ç‰ˆèªè¨€ï¼ˆä¸€ï¼‰èªæ³•åŸºç¤ç¯‡ | Blog - ç™½èŠ±æ®¿](https://www.shirohana.me/blog/articles/2020-mastery-pug-template-engine/)
    
    èªæ³•è½‰æ›ç·´ç¿’ï¼š
    
    [PugPlay](https://pug.vercel.app/)
    
</aside>

## Restful API (Application Programming Interface (æ‡‰ç”¨ç¨‹å¼ä»‹é¢))

[API æ˜¯ä»€éº¼? RESTful API åˆæ˜¯ä»€éº¼?](https://medium.com/itsems-frontend/api-%E6%98%AF%E4%BB%80%E9%BA%BC-restful-api-%E5%8F%88%E6%98%AF%E4%BB%80%E9%BA%BC-a001a85ab638)

[https://www.youtube.com/watch?v=zvKadd9Cflc&t=10s&ab_channel=Termsoup](https://www.youtube.com/watch?v=zvKadd9Cflc&t=10s&ab_channel=Termsoup)

RESTful API æ˜¯ä¸€ç¨®è¨­è¨ˆæ¨¡å¼ï¼Œä¸ä¸€å®šéƒ½èƒ½ç¬¦åˆï¼Œä½†ç›¡å¯èƒ½æ¥è¿‘

RESTï¼Œå…¨å Representational State Transfer( è¡¨ç¾å±¤ç‹€æ…‹è½‰ç§»)ï¼Œ**ä»–æ˜¯ä¸€ç¨®è¨­è¨ˆé¢¨æ ¼ ä¸æ˜¯æ¨™æº–**ï¼ŒRESTful åªæ˜¯è½‰ç‚ºå½¢å®¹è©ï¼ŒRESTful å‰‡å½¢å®¹ä»¥æ­¤è¦ç¯„è¨­è¨ˆçš„ APIï¼Œç¨±ç‚º RESTful API

- å®šç¾©ä¸€çµ„å¯ä»¥è¢«æ“ä½œçš„ç‰©ä»¶
- ç”¨ HTTP Method  ä¾†è¡¨é”å‹•ä½œ
    - GET è®€å–è³‡æº (readè®€å–)
    - PUT æ›¿æ›è³‡æº (updateæ›´æ–°)
    - PATCH æ›´æ›è³‡æºéƒ¨åˆ†å…§å®¹
    - DELETE åˆªé™¤è³‡æº(deleteåˆªé™¤)
    - OPTIONS å›å‚³è©²è³‡æºæ‰€æ”¯æ´çš„æ‰€æœ‰ HTTP è«‹æ±‚æ–¹æ³•
    - CONNECT å°‡é€£ç·šè«‹æ±‚è½‰æ›è‡³ TCP/IP éš§é“
    - POST æ–°å¢è³‡æº(createæ–°å¢)
    
    [HTTP method ä»‹ç´¹](https://www.notion.so/Http-Method-Http-CORS-9c2b2088e5ce4f8f8f0e2fa69e4558e8?pvs=21)
    

æ­£å¥½æœƒå°æ‡‰åˆ°è³‡æ–™åº«åŸºæœ¬æ“ä½œ CRUD å¢åˆªæŸ¥æ”¹ã€‚

> CRUD ç‚º Create(æ–°å¢)ã€Read(è®€å–)ã€Update(æ›´æ–°)èˆ‡Delete(åˆªé™¤)çš„ç¸®å¯«
> 

<aside>
ğŸ”¥ è‹¥ä»¥ RESTful API é¢¨æ ¼é–‹ç™¼ï¼š

```
ç²å¾—è³‡æ–™GET     /data
æ–°å¢è³‡æ–™POST    /data
åˆªé™¤è³‡æ–™DELETE  /data/1
```

å°±æ˜¯ç”¨ä¸€å€‹å”¯ä¸€çš„ URL å®šä½è³‡æºï¼Œå°‡å‹•ä½œè—åœ¨ HTTP çš„ method è£¡é¢ã€‚

</aside>

RESTful API ä¸»è¦ç”±ä¸‰ç¨®å…ƒä»¶çµ„æˆï¼š

![https://miro.medium.com/max/426/1*Vj-yqyvny36mMyk6Q5pXww.png](https://miro.medium.com/max/426/1*Vj-yqyvny36mMyk6Q5pXww.png)

1. Nouns åè©ï¼šå®šç¾©è³‡æºä½ç½®çš„ URLï¼Œæ¯å€‹è³‡æºåœ¨ç¶²è·¯ä¸Šéƒ½æœƒæœ‰å”¯ä¸€çš„ä½ç½®ï¼Œå°±å¦‚æ¯æˆ¶äººå®¶éƒ½æœ‰å”¯ä¸€çš„åœ°å€ä¸€æ¨£ã€‚
2. Verbs å‹•è©ï¼šå°è³‡æºè¦åšçš„å‹•ä½œã€‚
3. Content Types è³‡æºå‘ˆç¾æ–¹å¼ï¼šAPI è³‡æºå¯ä»¥ä»¥å¤šç¨®æ–¹å¼è¡¨ç¾ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ JSONï¼Œè¼ƒè¼•ï¼Œä¹Ÿè¼ƒå¥½è™•ç†ã€‚

### RESTful API å„ªå‹¢ï¼š

1. æœ‰å”¯ä¸€çš„URLè¡¨ç¤ºè³‡æºä½ç½®ï¼Œçµ±ä¸€çš„ API æ¥å£ã€‚(Uniform Interface)
2. ç„¡ç‹€æ…‹ã€‚(Stateless)â†’
    
    RESTful çš„ç‹€æ…‹ï¼Œæ„å³ HTTP çš„è«‹æ±‚ç‹€æ…‹ã€‚
    
    ä¸€èˆ¬ Web æœå‹™ä¸­ï¼ŒServer ç«¯å’Œ Client ç«¯äº¤äº’çš„è³‡è¨Šï¼Œ**æœƒå­˜åœ¨ Server ç«¯çš„ Session (ä¾‹å¦‚ï¼šå·²ç™»å…¥ç‹€æ…‹)**ï¼Œåœ¨ Client ç«¯å†æ¬¡ç™¼é€è«‹æ±‚çš„æ™‚å€™ï¼ŒServer ç«¯é€éä¿å­˜åœ¨ Server ç«¯çš„ Sessionï¼Œå»åŸ·è¡Œ requestã€‚
    
    ç„¡ç‹€æ…‹çš„æ„æ€ï¼Œå³Â **Client ç«¯è‡ªè¡Œä¿å­˜ç‹€æ…‹**ï¼Œåœ¨è«‹æ±‚ Server çš„æ™‚å€™ï¼Œä¸€ä½µé™„ä¸Šçµ¦ Server ç«¯ï¼ŒServer ç«¯ç„¡ä¿å­˜ Client ç«¯çš„ç‹€æ…‹è³‡è¨Šã€‚
    
    <aside>
    ğŸ”¥ èˆ‰ä¾‹ä¾†èªªï¼Œå¯èƒ½åœ¨ç”¨æˆ¶ç™»éŒ„ç³»çµ±æ™‚ï¼ŒServer ç”¢ç”Ÿ token ç´€éŒ„ user å·²ç™»éŒ„ç³»çµ±ï¼Œ**ç„¶å¾ŒæŠŠ token é‚„çµ¦ Client**ï¼Œåœ¨ Client å†æ¬¡ç™¼é€è«‹æ±‚çš„æ™‚å€™ï¼ŒæŠŠ token ä¸€èµ·ç™¼çµ¦ Serverï¼Œé€™æ¨£ Server å°±çŸ¥é“é€™ä¸€å€‹ Client æ˜¯å·²ç¶“è™•æ–¼ç™»éŒ„çš„ç‹€æ…‹ã€‚
    
    </aside>
    
3. å¯æ›´é«˜æ•ˆåˆ©ç”¨å¿«å–ä¾†æé«˜å›æ‡‰é€Ÿåº¦ (Cachable)
    
    
    - åœ¨ server-sideï¼ŒGET éçš„è³‡æºï¼Œå¦‚æœæ²’æœ‰è¢«è®Šæ›´éï¼Œå¯ä»¥åˆ©ç”¨ cache æ©Ÿåˆ¶æ¸›å°‘ requestã€‚
    
    - åœ¨ client-sideï¼Œé€é client ç«¯ cache ç´€éŒ„ cache ç‰ˆæœ¬ï¼Œè‹¥å‘ server è¦æ±‚è³‡æºæ™‚ç™¼ç¾ server æœ€æ–°ç‰ˆèˆ‡ cache ç›¸åŒï¼Œå‰‡ client ç«¯ç›´æ¥å–ç”¨æœ¬åœ°è³‡æºå³å¯ï¼Œä¸éœ€è¦å†åšä¸€æ¬¡æŸ¥è©¢
4. åˆ†å±¤ç³»çµ±æ¶æ§‹ (Layered System)
5. **å®¢æˆ¶ç«¯æœå‹™å™¨åˆ†é›¢ (Client-Server)**
6. å……ä»½åˆ©ç”¨ HTTP protocal(GET/POST/PUT/DELETE) (Manipulation of resources through representations)
7. å¯åŸ·è¡Œç¨‹å¼ç¢¼çš„è¨­è¨ˆï¼Œåƒæ˜¯ JavaScriptï¼ˆéå¿…è¦å¯¦ä½œé …ç›®ï¼‰ Code-On-Demand (optional)

e.g. GET /customers/1/orders

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%204.png)

## å’Œè³‡æ–™åº«äº’å‹• createPool

[mySqlâ†’ **MySQL 2 connection pool**](https://www.notion.so/MySQL-84b415c828244e2298aeb76bb8ca2e07?pvs=21)

- ä½¿ç”¨ connection pool --> å»ºè­°ä½¿ç”¨çš„æ–¹å¼
    - å»ºç«‹ä¸€çµ„é€£ç·šçµ¦å¤§å®¶å…±ç”¨ï¼ˆé‡è¤‡ä½¿ç”¨ï¼‰
- åŸæœ¬çˆ¬èŸ²ç·´ç¿’ â†’ç¼ºé»: æ…¢(å»ºç«‹é€£ç·šã€é‡‹æ”¾é€£ç·šæ˜¯å¾ˆæ…¢çš„äº‹æƒ…)ã€é€£ç·šæ•¸é‡ç„¡æ³•æ§åˆ¶(è³‡æ–™åº«èƒ½æ‰¿å—çš„é€£ç·šæ•¸æœ‰é™)

```jsx
 // å¼•å…¥ npm i mysql2
const mysql = require('mysql2');

let pool = mysql
  .createPool({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    **// é™åˆ¶ pool é€£ç·šæ•¸çš„ä¸Šé™
    connectionLimit: 10,
    dateStrings: true, //mysql2å¥—ä»¶æœƒè‡ªå‹•å°‡æ—¥æœŸè½‰æ›æˆjavascriptçš„æ—¥æœŸç‰©ä»¶ å¯ä»¥åˆ©ç”¨dateStrings è¨­å®šå›ä¾†ï¼šä¿æŒdateæ˜¯ string**
  })
  .promise();
```

## å‰å¾Œç«¯äº’å‹•

**å·²å®Œæˆï¼šå¾Œç«¯ çˆ¬èŸ²æŠ“å–è‚¡ç¥¨è³‡æ–™[axios å¥—ä»¶ å‰å¾Œç«¯å‚³éè³‡æ–™](https://www.notion.so/axios-b0ee81cb514945cb94948353aa8c6c34?pvs=21)** 

**å·²å®Œæˆï¼šå°‡è‚¡ç¥¨è³‡æ–™å­˜å…¥ è³‡æ–™åº«äº’å‹• [axios å¥—ä»¶ å‰å¾Œç«¯å‚³éè³‡æ–™](https://www.notion.so/axios-b0ee81cb514945cb94948353aa8c6c34?pvs=21)** 

**å·²å®Œæˆï¼šå¾Œç«¯åˆ©ç”¨express è£½ä½œä¼ºæœå™¨ è¨­å®š api ç¶²å€ æœ¬é ä¸Šæ–¹**

### **æ¥ä¸‹ä¾†ç¹¼çºŒï¼š å‰ç«¯åˆ©ç”¨å¾Œç«¯api ç¶²å€æŠ“å–è³‡æ–™åº«çš„è³‡æ–™ æ¸²æŸ“åœ¨å‰ç«¯é é¢**

1. è¨­å®šå¾Œç«¯api é€£å‹•è³‡æ–™åº«è·¯å¾‘ï¼š
    
    ```jsx
    //backend server.js
    
    // åˆ—å‡ºæ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼
    app.get('/api/1.0/stocks', async (req, res, next) => {
      console.log('/api/1.0/stocks');
      // å¯«æ³•1
      // let result = await pool.execute('SELECT * FROM stocks');
      // let data = result[0];
      // ES6 å¯«æ³• (å¯«æ³•2)
      let [data] = await pool.query('SELECT * FROM stocks');
      res.json(data);
    });
    
    //åˆ—å‡ºæŸå€‹è‚¡ç¥¨ä»£ç¢¼çš„è©³ç´°è³‡æ–™->ï¼ˆæ‰€æœ‰å ±åƒ¹è³‡æ–™ï¼‰
    app.get('/api/1.0/stocks/:stockId', async (req, res, next) => { 
      const stockId = req.params.stockId;**//:stockId è¡¨ç¤ºè®Šæ•¸ ç”¨paramå–å¾—**
      let [data] = await pool.query(
        'SELECT * FROM stock_prices WHERE stock_id =?', // sqlèªæ³•
        [stockId]
      );
      //å‰ç«¯æ‰“api æ™‚æœ‰æ‹¿åˆ°è‚¡ç¥¨ä»£ç¢¼ æ‹¿é€™å€‹ä»£ç¢¼åœ¨ä½¿ç”¨req.param.stockIDå¾Œç«¯å–å‡ºè®Šæ•¸
      res.json(data);
    });
    ```
    

3. å‰ç«¯å°‡æŠ“å–åˆ°çš„è³‡æ–™æ¸²æŸ“é é¢

```jsx
// åˆ©ç”¨map å°‡dataé€ä¸€æ”¾åœ¨éœ€æ±‚çš„ä½ç½®

{data.map((value, index) => {
        return (
          <div
            key={value.id}
            className="bg-white bg-gray-50 p-6 rounded-lg shadow hover:shadow-lg m-6 cursor-pointer"
          >
            <Link to={`/stock/${value.id}`}>
              <h2 className="text-2xl font-bold mb-2 text-gray-800">
                {value.id}
              </h2>
              <p className="text-gray-700">{value.name}</p>
            </Link>
          </div>
        );
      })}
```

```jsx
// 1. é€™è¡Œä»¥ä¸‹çš„å…¨ç«™æœ‰æ•ˆ
app.use(express.json());

// 2. é€™è¡Œä»¥ä¸‹çš„ã€åŒä¸€å€‹ router è£¡æœ‰æ•ˆ
router.use(express.json());

// 3. é‡å°æŸä¸€å€‹ç‰¹æ®Šçš„è·¯ç”± 
router.post('/api/1.0/auth/login', (req, res, next) => {});
router.post('/api/1.0/auth/register', express.json(), (req, res, next) => {});

// æ”¾ä¸€çµ„
// å¯«æ³• 1 æ’åœ¨è·¯ç”±ä¸­é–“ä»¶è£¡é¢ ç¬¬äºŒå€‹åƒæ•¸
router.post('/api/1.0/auth/register', express.json(), ç¬¬äºŒå€‹ä¸­é–“ä»¶, (req, res, next) => {});
// å¯«æ³• 2 æ’åœ¨è·¯ç”±ä¸­é–“ä»¶ç¬¬äºŒå€‹åƒæ•¸ï¼ˆä¸€å€‹ä»¥ä¸Šä¸­é–“ä»¶åšæˆé™£åˆ—å­˜ï¼‰
router.post('/api/1.0/auth/register', [express.json(), ç¬¬äºŒå€‹ä¸­é–“ä»¶], (req, res, next) => {});
// å¯«æ³• 3 å¯«æ³•2çš„é™£åˆ—ç”¨è®Šæ•¸å­˜å–
let middlewares = [express.json(), ç¬¬äºŒå€‹ä¸­é–“ä»¶];
router.post('/api/1.0/auth/register', middlewares, (req, res, next) => {});
```

1. å‰ç«¯react æ¡†æ¶ å‘å¾Œç«¯å–è³‡æ–™
    
    ```jsx
    // frontend Stock.js
    
    //ä½¿ç”¨ axios å’Œå¾Œç«¯è¦è³‡æ–™ä¹‹å¾Œå­˜åœ¨useStateç‹€æ…‹è£¡ä½¿ç”¨
    const [data, setData] = useState([]);
    
    useEffect(() => {
        console.log('é–‹å§‹çš„è³‡æ–™', data);
        let getStock = async () => {
          let res = await axios.get('http://localhost:3002/api/1.0/stocks');
          console.log('æŠ“åˆ°çš„è³‡æ–™', res);
          setData(res.data);
          console.log('æŠ“åˆ°çš„è³‡æ–™(æ•´ç†é)', data);
        };
        getStock();
      }, []);
    
    // frondend StockDetails.js
    
    //ä½¿ç”¨ axios å’Œå¾Œç«¯è¦è³‡æ–™ä¹‹å¾Œå­˜åœ¨useStateç‹€æ…‹è£¡ä½¿ç”¨
    const [data, setData] = useState([]);
    
    // æŠŠç¶²å€ä¸Šçš„ :stockId æ‹¿å‡ºä¾†
      const { stockId } = useParams(); **// ä½¿ç”¨ useParamå–å¾—ç¶²å€å­—ä¸²**
      console.log('StockID', stockId);
    
    useEffect(() => {
        console.log('StockID', stockId);
        let getStockDetail = async () => {
          let response = await axios.get(
            `http://localhost:3002/api/1.0/stocks/${stockId}`
          );
          setData(response.data);
        };
        getStockDetail();
      }, [])
    ```
    

### è£œå……ï¼š

> request.params => è®Šæ•¸åœ¨apiç¶²å€ä¸Š ex: /stock/123
request.query => è®Šæ•¸åœ¨ query string ä¸Š ex: /stock/123?page=1
request.body => form post
> 

[ã€ Node.js ã€‘ç‚ºä»€éº¼è¦ä½¿ç”¨ express bodyparser å‘¢ï¼Ÿ - Jimmy çš„æ¶ç«™ç­†è¨˜](https://jimmyswebnote.com/why-use-express-bodyparser/)

```jsx
// è¦è®“ express èªå¾— json
// é è¨­è™•ç† Content-Type æ˜¯ "application/json" çš„
app.use(express.json());

// express.urlencoded è¦è®“ express èªå¾— body è£¡çš„è³‡æ–™
// extended: false -> querystring
// extended: true -> qs
// é è¨­è™•ç† Content-Type æ˜¯ "application/x-www-form-urlencoded" çš„
app.use(express.urlencoded({ extended: true }));

// ä½¿ç”¨ multer
// Content-Type: multipart/form-data
```

### **ä¾†æº**

- æˆ‘å€‘è‡ªå·±é–‹ç™¼çš„
- ç¬¬ä¸‰æ–¹, e.g. cors
- express å…§å»ºçš„, e.g. express.json()

### **ä½ç½®**

- app
- router
- é‡å°æŸä¸€å€‹ç‰¹æ®Šçš„è·¯ç”±

### cors ä¸­é–“ä»¶ ï¼ˆè·¨æºå•é¡Œï¼‰[npm å¥—ä»¶](https://www.notion.so/npm-114585b3aff84212a5f1d753e852aaf0?pvs=21)

Cross-Origin Resource Sharing è·¨æºè³‡æºå…±äº«

ã€Œæºã€ï¼šåŒæº vs è·¨æº

- é€šè¨Šå”å®š protocol: http vs https ä¸åŒæº
- ç¶²åŸŸ domain name:Â `www.example.com`Â vsÂ `api.example.com` ä¸åŒæº
- é€šè¨ŠåŸ  port:Â [www.example.com:3000](http://www.example.com:3000/)Â vsÂ [www.example.com:3002](http://www.example.com:3002/) ä¸åŒæº

[[æ•™å­¸] CORS æ˜¯ä»€éº¼? å¦‚ä½•è¨­å®š CORS?](https://shubo.io/what-is-cors/)

ex: å°æ¸¬è©¦

```
origin: http://www.example.com
(1) http://api.example.com -> è·¨ domain
(2) https://www.example.com -> è·¨ protocol
(3) http://www.example.com:3000 -> è·¨ port 3000
(4) http://www.example.com:80 -> åŒ
(5) http://www.example.com/test.html -> åŒ
```

> ä¸åŒæºçš„å‰ç«¯è‹¥å˜—è©¦å°**ç€è¦½å™¨æ‰“api æœƒè¢«æ“‹ä¸‹**,æ‰€ä»¥éœ€è¦ä½¿ç”¨ cors è¨­å®šå…è¨±è·¨æº
> 

ã€Œç€è¦½å™¨ã€ä¸å…è¨±è·¨æºçš„ AJAX è«‹æ±‚,å¾Œç«¯ç¶²ç«™å¯ä»¥å…è¨±è·¨æº

- å‰ç«¯port 3000 å˜—è©¦å° å¾Œç«¯ port 3002 æ‰“api è¢«ç€è¦½å™¨é–èµ·ä¾†
    
    åŸºæ–¼å®‰å…¨æ€§è€ƒé‡ï¼Œç¨‹å¼ç¢¼æ‰€ç™¼å‡ºçš„è·¨ä¾†æº HTTP è«‹æ±‚æœƒå—åˆ°é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œ`[XMLHttpRequest](https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest)`åŠÂ `[Fetch](https://developer.mozilla.org/zh-TW/docs/Web/API/Fetch_API)`éƒ½éµå®ˆ[åŒæºæ”¿ç­–ï¼ˆsame-origin policyï¼‰](https://developer.mozilla.org/zh-TW/docs/Web/Security/Same-origin_policy)ã€‚
    
    é€™ä»£è¡¨ç¶²è·¯æ‡‰ç”¨ç¨‹å¼æ‰€ä½¿ç”¨çš„ API é™¤éä½¿ç”¨ CORS æ¨™é ­ï¼Œå¦å‰‡åªèƒ½è«‹æ±‚èˆ‡æ‡‰ç”¨ç¨‹å¼ç›¸åŒç¶²åŸŸçš„ HTTP è³‡æºã€‚
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%205.png)
    
    <aside>
    â˜ğŸ» è·¨ä¾†æºè«‹æ±‚çš„ Cookie
    
    ä¸€èˆ¬çš„ http request æœƒå¸¶æœ‰è©²ç¶²åŸŸåº•ä¸‹çš„ cookieï¼›ç„¶è€Œï¼Œ**è·¨ä¾†æºè«‹æ±‚é è¨­æ˜¯ä¸èƒ½å¸¶ cookie çš„ã€‚**
    
    ç‚ºä»€éº¼å‘¢ï¼Ÿå› ç‚ºå¸¶æœ‰ cookie çš„è«‹æ±‚éå¸¸å¼·å¤§ï¼Œå¦‚æœè«‹æ±‚æ”œå¸¶çš„ cookie æ˜¯ session tokenï¼Œé‚£é€™å€‹è«‹æ±‚å¯ä»¥ä»¥ä½ çš„èº«ä»½åšå¾ˆå¤šæ©Ÿæ•çš„äº‹æƒ…ï¼Œåƒæ˜¯å­˜å–ä½ çš„éš±ç§è³‡æ–™ã€å¾ä½ çš„éŠ€è¡Œå¸³æˆ¶è½‰å¸³ç­‰ã€‚
    
    - `credentials`
    
    é€é fetch API ç™¼é€è·¨ä¾†æºè«‹æ±‚ï¼Œéœ€è¦è¨­å®šÂ `credentials: 'include'`ï¼š
    
    ```jsx
    fetch('[https://othersite.com/data](https://othersite.com/data)', {
      credentials: 'include'
    })
    ```
    
    - `withCredentials`
    
    é€é XMLHttpRequest ç™¼é€è·¨ä¾†æºè«‹æ±‚ï¼Œéœ€è¦è¨­å®šÂ `withCredentials = true;`
    
    ```jsx
    const xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.open('POST', '[https://othersite.com/data](https://othersite.com/data)');
    ```
    
    å¦‚æ­¤ä¸€ä¾†è·¨ä¾†æºè«‹æ±‚å°±æœƒæ”œå¸¶ cookie äº†ï¼
    
    </aside>
    

```jsx
**// ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼Œè¦å…ˆå®‰è£: npm i cors**
const cors = require('cors');
// ä½¿ç”¨é€™å€‹ç¬¬ä¸‰æ–¹æä¾›çš„ cors ä¸­é–“ä»¶
// ä¾†å…è¨±è·¨æºå­˜å– // å‰ç«¯port 3000 å¾Œç«¯ port 3002
// é è¨­éƒ½æ˜¯å…¨éƒ¨é–‹æ”¾
// app.use(cors());
// ä½¿ç”¨æƒ…å¢ƒ: **ç•¶å‰å¾Œç«¯ç¶²å€ä¸åŒæ™‚ï¼Œåªæƒ³å…è¨±è‡ªå·±çš„å‰ç«¯ä¾†è·¨æºå­˜å–**
//          å°±å¯ä»¥åˆ©ç”¨ origin é€™å€‹è¨­å®šä¾†é™åˆ¶ï¼Œ**ä¸ç„¶é è¨­æ˜¯ * (å…¨éƒ¨)**
const corsOptions = {
   origin: ['http://localhost:3000'],
 };
 app.use(cors(corsOptions));

// è‹¥æ²’å¸¶å…¥ç‰©ä»¶åƒæ•¸ å‰‡é–‹æ”¾å…¨éƒ¨å‰ç«¯éƒ½å¯ä»¥è·¨æºæ‰“api è‹¥å¸¶å…¥æŒ‡å®šurl ç¶²å€ç‰©ä»¶,
// å‰‡å¯ä»¥æŒ‡å®šè©²ç¶²å€å¯ä»¥è·¨æº
```

<aside>
ğŸ”¥ Server ç«¯ä¹Ÿéœ€è¦é¡å¤–çš„è¨­å®šï¼šå¦‚æœæ˜¯ä¿¡ä»»çš„ä¾†æºï¼Œå›æ‡‰è¦å¸¶æœ‰Â `Access-Control-Allow-Credentials`Â headerï¼š

```jsx
Access-Control-Allow-Credentials: true
```

å¦‚æ­¤ä¸€ä¾†ï¼Œç€è¦½å™¨æ‰æœƒå°‡ cookie å¯«é€²è©² domainã€‚

</aside>

> ç”±æ–¼æ˜¯å¾å¾Œç«¯ 3002 æ‰“api åˆ°å¤–éƒ¨ç¶²ç«™å–å¾—è³‡æ–™å¾Œå­˜åœ¨è³‡æ–™åº«
> 
> 
> ç„¶å¾Œå‰ç«¯3000 æ‰“api é€šçŸ¥å¾Œç«¯3002æä¾›è³‡æ–™ æœ‰è·¨åŸŸå•é¡Œ å› æ­¤ä½¿ç”¨ corså¥—ä»¶è§£æ±º
> 

```jsx
const corsOptions = {
  origin: ['http://localhost:3000'],
};
app.use(cors(corsOptions));
// è‹¥æ²’å¸¶å…¥ç‰©ä»¶åƒæ•¸ å‰‡é–‹æ”¾å…¨éƒ¨å‰ç«¯éƒ½å¯ä»¥è·¨æºæ‰“api è‹¥å¸¶å…¥æŒ‡å®šurl ç¶²å€ç‰©ä»¶,å‰‡å¯ä»¥æŒ‡å®šè©²ç¶²å€å¯ä»¥è·¨æº
```

## ä»¥ä¸Šåšå®Œå¾Œâ€¦å¢æ·»é€²éšåŠŸèƒ½

### åˆ†é åŠŸèƒ½-å¾Œç«¯

- å‰ç«¯åˆ†é : æ‰€æœ‰çš„è³‡æ–™éƒ½æ‹¿åˆ°å‰ç«¯å¾Œï¼Œç”±å‰ç«¯ä¾†åˆ†é 
    - **å„ªé»: è«‹æ±‚åªæœ‰1æ¬¡ï¼Œå¾ŒçºŒçš„æ›é æœƒå¾ˆå¿«ï¼ˆå› ç‚ºå‰ç«¯å·²ç¶“æœ‰å…¨éƒ¨çš„è³‡æ–™ï¼‰**
    - ç¼ºé»: ç¬¬ä¸€æ¬¡å°±æŠŠè³‡æ–™æ‹¿å…¨ï¼Œè² æ“”å¾ˆé‡(è³‡æ–™åº«ã€å‚³è¼¸é‡)ï¼Œä½¿ç”¨è€…é€šå¸¸ä¸æœƒçœ‹åˆ°å¾Œé¢å¹¾é çš„è³‡æ–™

<aside>
ğŸ‘‰ğŸ» è£½ä½œå‰ç«¯åˆ†é  ï¼šå¯åƒè€ƒreact ä½œæ³• or å¼•å…¥å¥—ä»¶ or javascript

</aside>

- å¾Œç«¯åˆ†é : å‰ç«¯æ¯æ¬¡åªè·Ÿå¾Œç«¯æ‹¿è©²é çš„è³‡æ–™
    - å„ªé»: ä¸ç”¨æ‹¿å…¨éƒ¨è³‡æ–™ï¼Œåªæ‹¿éœ€è¦çš„å°±å¥½
    - ç¼ºé»: æ¯æ¬¡æ›é éƒ½éœ€è¦å»è·Ÿå¾Œç«¯æ‹¿ä¸€æ¬¡è³‡æ–™

<aside>
ğŸ”¥ è£½ä½œ å¾Œç«¯åˆ†é  ä»»å‹™ï¼šåœ¨å¾Œç«¯åˆ†æ‰¹å–å‡ºè³‡æ–™çµ¦å‰ç«¯è™•ç†æ¸²æŸ“ç•«é¢

### å¾Œç«¯è¨­å®šéœ€è¦æŠ“å–çš„è³‡æ–™å…§å®¹ â€”>æ¯”ç…§å³æ–¹ç¨‹å¼ç¢¼

- [ ]  A. æ±ºå®šä¸€é è¦æœ‰å¹¾ç­† perPage
- [ ]  B. å¾ query string å–å¾—ç›®å‰åœ¨ç¬¬å¹¾é ï¼Œè¦æœ‰é è¨­å€¼ï¼Œæ²’æœ‰è¨­å®šå°±æ˜¯è¦ç¬¬ä¸€é çš„è³‡æ–™ page
- [ ]  C. å¾è³‡æ–™åº«å–å¾—è©²è‚¡ç¥¨ä»£ç¢¼çš„ç¸½ç­†æ•¸ total
- [ ]  D. å¾ total èˆ‡ perPage ç®—å‡ºç¸½é æ•¸ lastPage (hint: Math.ceil)
- [ ]  E. è¨ˆç®—å–å¾—è©²é è³‡æ–™é ˆè¦è·³éå¹¾ç­† offset
- [ ]  F. æ ¹æ“š perPage åŠ offset å¾è³‡æ–™åº«å–å¾—è©²é è³‡æ–™
- [ ]  G. å›å‚³è³‡æ–™: pagination (å‰ç«¯å¯èƒ½éœ€è¦çš„é ç¢¼è³‡æ–™)èˆ‡ data

```sql
- æ³¨æ„ mysql2 å¥—ä»¶å›å‚³çš„è³‡æ–™æ ¼å¼
SELECT COUNT(*) AS total FROM stock_prices WHERE stock_id=?
SELECT * FROM stock_prices WHERE stock_id = ? ORDER BY date LIMIT ? OFFSET ?
```

```jsx
// backend server.js
app.get('/api/1.0/stocks/:stockId', async (req, res, next) => {
  const stockId = req.params.stockId;
  // å¾Œç«¯åˆ†é  ->åœ¨å¾Œç«¯åˆ†æ‰¹å–å‡ºè³‡æ–™çµ¦å‰ç«¯

  **// B. é€équery string å–å¾—å‰ç«¯æ‰“ä¾†çš„apiç¶²å€è³‡æ–™ï¼ˆç¬¬å¹¾é ï¼‰ æˆ–æ²’è¨­å®šå°±æ˜¯é è¨­ç¬¬ä¸€é è³‡æ–™**
  let page = req.query.page || 1; 
  const perPage = 5; //A. è¨­å®šæ¯é é¡¯ç¤ºç­†æ•¸ï¼ˆæ¯æ¬¡æ›é æŠ“å–ç­†æ•¸ï¼‰

  //C. TODO: æŸ¥è©¢è³‡æ–™åº« ï¼šå–å¾—ç¸½ç­†æ•¸ ex: 57 (sql èªæ³•å¯ä½¿ç”¨)
  let [total] = await pool.execute(
    'SELECT COUNT(*) AS total FROM stock_prices WHERE stock_id =?',
    [stockId]
  );
  total = total[0].total;
  // sql èªæ³•çš† æœƒå›å‚³é™£åˆ—[{total:'ç­†æ•¸'}] å› æ­¤é‚„è¦å¤šè™•ç†
  //D. TODO:å–å¾—ç¸½é æ•¸  --> ç¸½ç­†æ•¸/ æ¯é é¡¯ç¤ºç­†æ•¸ ï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
  let lastPage = Math.ceil(total / perPage);

  //E. TODO:è¨ˆç®— offset (åœ¨sqlèªæ³•è£¡é¢ä»£è¡¨è·³éå“ªäº›è³‡æ–™ä¸æ‹¿å–)
// offset åœ¨é ç¢¼çš„æ¦‚å¿µå°±æ˜¯ï¼š å‡è¨­æ¯é é¡¯ç¤º5ç­†è³‡æ–™ ç¬¬äºŒé é¡¯ç¤º6-10ç­†è³‡æ–™ å› æ­¤è·³éå‰5ç­† å¾ç¬¬6ç­†é–‹å§‹æŠ“å–
// ç¬¬ä¸€é  1-5
// ç¬¬äºŒé  6-10

  const offset = perPage * (page - 1);

  // sql èªæ³• 'SELECT * FROM stock_prices WHERE stock_id =? ORDER BY date LIMIT perPage OFFSET offset',  

  //F. TODO:æ ¹æ“šä»¥ä¸Šå–å¾—è³‡æ–™
  let [data] = await pool.execute(
    'SELECT * FROM stock_prices WHERE stock_id =? ORDER BY date LIMIT ? OFFSET ?',
    [stockId, perPage, offset]
  );
  // G. å°‡è³‡æ–™æ•´ç†å¥½æ–¹ä¾¿å‰ç«¯æ‰“apiå–ç”¨  ->å‰ç«¯æ‰“apiä¾†çš„æ™‚å€™ å°±æœƒæä¾›é€™åŒ…è³‡æ–™
  res.json({
    pagination: {
      total: total,
      perPage: perPage,
      page: page,
      lastPage: lastPage,
    },
    data,
  });
```

### å‰ç«¯è¨­å®šé ç¢¼ç‹€æ…‹ï¼† æ¸²æŸ“æ¨£å¼â€”>æ¯”ç…§å³æ–¹ç¨‹å¼ç¢¼

- [ ]  A. å¢åŠ  lastPage(ç¸½é æ•¸) èˆ‡ page (ç›®å‰åœ¨ç¬¬å¹¾é ) çš„ state
- [ ]  B. å…ˆé–‹ç™¼é ç¢¼ï¼Œå¯ä»¥é€éä¿®æ”¹ lastPage èˆ‡ page é€™å…©å€‹ state çš„é è¨­å€¼ä¾†æ¸¬è©¦
- [ ]  C. é ç¢¼é»æ“Šå¾Œï¼Œè¦ setPage å»æ”¹è®Š page state
- [ ]  D. å¾å¾Œç«¯å–å¾—è³‡æ–™å¾Œï¼Œè¦å¾ pagination ç‰©ä»¶è£¡å–å¾—ç¸½é æ•¸ (lastPage)
- [ ]  E. åœ¨ page çš„ effect å»å¾Œç«¯å–å¾—è©²é è³‡æ–™

> hint: ç•¶æˆ‘å€‘åœ¨è¨­å®š state é è¨­å€¼æ™‚ï¼Œä¹Ÿæœƒè§¸ç™¼ useEffect
> 

B. è£½ä½œé ç¢¼æ¨£å¼ ç”¨javascript push æ–¹æ³•æ”¾åœ¨return è£é¢

```jsx
const getPages = () => {
    //è£½ä½œå­˜å–é ç¢¼å®¹å™¨(é™£åˆ—)
    let pages = [];
    for (let i = 1; i <= lastPage; i++) {
      pages.push(
        <li
          style={{
            display: 'inline-block',
            margin: '2px',
            backgroundColor: page === i ? '#00d1b2' : '',
            borderColor: page === i ? '#00d1b2' : '#dbdbdb',
            color: page === i ? '#fff' : '#363636',
            borderWidth: '1px',
            width: '28px',
            height: '28px',
            borderRadius: '3px',
            textAlign: 'center',
          }}
          key={i}
          onClick={(e) => {
            setPage(i); // C. ä¿®æ”¹pageç‹€æ…‹ æ’ˆå¾Œç«¯è³‡æ–™
          }}
        >
          {i}
        </li>
      );
    }
    return pages;
  };
```

```jsx
// A. è¨­å®šé ç¢¼ç‹€æ…‹
  const [lastPage, setLastPage] = useState();
// ç›®å‰åœ¨ç¬¬å¹¾é 
  const [page, setPage] = useState(1);// é è¨­ç¬¬ä¸€é 

  // æŠŠç¶²å€ä¸Šçš„ :stockId æ‹¿å‡ºä¾† æ‰“apiç”¨
  const { stockId } = useParams();

  console.log('StockID', stockId);
  // D. å°‡æ”¶é›†åˆ°çš„è³‡æ–™å»å¾Œç«¯æ’ˆ
  useEffect(() => {
    console.log('StockID', stockId);
    let getStockDetail = async () => {
      let response = await axios.get(
        `http://localhost:3002/api/1.0/stocks/${stockId}?page=${page}`
      );
      // 2. setData
      setData(response.data.data);
      // D. å¾å¾Œç«¯å–å¾—ç¸½é æ•¸æ›´æ–°æ¸²æŸ“
      setLastPage(response.data.pagination.lastPage);
    };
    getStockDetail();
  }, [page]); //E. æ‰“api æ™‚æ©Ÿï¼š ä¸€é–‹å§‹è¼‰å…¥æ­¤é é¢ ï¼†pagesæœ‰æ›´æ–°ç‹€æ…‹çš„æ™‚å€™
```

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%206.png)

</aside>

### æ¨¡çµ„åŒ–

- CJS: CommonJSï¼Œä¸æ˜¯ JS å…§å»ºçš„ï¼Œ**NodeJS æœ‰å¯¦ç¾ â†’ ç€è¦½å™¨ä¸èƒ½ç”¨**ï¼Œé™¤éåƒæ˜¯ webpack ç­‰å·¥å…·æœ‰å”åŠ©è½‰è­¯module.exports / require

[node js module æ¦‚å¿µ](https://www.notion.so/node-js-module-398af524446b4cf980b233b018dd5554?pvs=21) 

```jsx
let fs = require('readfile/promise');
// å¾å¤–éƒ¨æˆ–è€…å…§å»ºå¥—ä»¶å¼•å…¥

```

- ESM: ES2015 module â†’ JS å…§å»ºçš„æ¨¡çµ„export / import, Nodejs ä¹Ÿæ”¯æ´

[https://www.youtube.com/watch?v=qJWALEoGge4&ab_channel=uidotdev](https://www.youtube.com/watch?v=qJWALEoGge4&ab_channel=uidotdev)

### æ•´ç†code/ è™•ç†æ©Ÿæ•è³‡è¨Š -å‰ç«¯

æ–°å¢utilsæª”æ¡ˆå¤¾ å°‡å‰ç«¯çš„è¨­å®šæ”¾åœ¨config.jsè£é¢ â€”> è¨˜å¾—ä¸è¦push ä¸Šå»github

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%207.png)

.env åŠ ä¸Šä»¥ REACT_APP_ é–‹é ­çš„ç’°å¢ƒè®Šæ•¸è¨­å®š

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%208.png)

è®“å…¨ç«™ç¨‹å¼ç¢¼å¯ä»¥å…±ç”¨è¨­å®šï¼Œè€Œä¸æ˜¯æŠŠè¨­å®š(åƒæ˜¯å¾Œç«¯ç¶²å€)æ•£è½åœ¨ç¨‹å¼ç¢¼çš„å„è™•, å¯å°‡magic number è¨­å®šåœ¨configæª”çµ±ä¸€è™•ç†

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%209.png)

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2010.png)

> Refactor é‡æ§‹
> 
> 
> ã€Œåœ¨ä¸æ”¹è®Šè»Ÿé«”å¤–éƒ¨è¡Œç‚ºçš„å‰æä¸‹ï¼Œæ”¹è®Šå…¶å…§éƒ¨çµæ§‹ï¼Œä½¿å…¶æ›´å®¹æ˜“ç†è§£ä¸”æ˜“æ–¼ä¿®æ”¹ã€
> 

### å¾Œç«¯è³‡æ–™åº«å­˜å–ç¨ç«‹æˆmodule

1. å»ºç«‹é€šç”¨è³‡æ–™å¤¾utils æŠŠserver.js è£é¢é—œæ–¼è³‡æ–™åº«é€£å‹•çš„æ¨¡çµ„æ”¾å…¥db.js, è¨˜å¾—ä¹Ÿæ·»åŠ æ‰€éœ€çš„å¼•ç”¨æª” ex. mysql2â€¦

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2011.png)

1. åœ¨server.js å¼•å…¥ db.js æ¨¡çµ„

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2012.png)

1. router æ˜¯express è£¡é¢å…§å»ºçš„ mini-app 
    
    <aside>
    â˜ğŸ» `express.Router`é¡åˆ¥ç”¨ä¾†å»ºç«‹å¯è£è¼‰çš„æ¨¡çµ„è·¯ç”±è™•ç†ç¨‹å¼ã€‚
    
    - ç¯„ä¾‹
        
        ```jsx
        var express = require('express');
        var router = express.Router();
        
        // middleware that is specific to this router
        router.use(function timeLog(req, res, next) {
          console.log('Time: ', Date.now());
          next();
        });
        // define the home page route
        router.get('/', function(req, res) {
          res.send('Birds home page');
        });
        // define the about route
        router.get('/about', function(req, res) {
          res.send('About birds');
        });
        
        module.exports = router;
        ```
        
        ç„¶å¾Œå°‡è·¯ç”±å™¨æ¨¡çµ„è¼‰å…¥æ‡‰ç”¨ç¨‹å¼ä¸­ï¼š
        
        ```jsx
        var birds = require('./birds');
        ...
        app.use('/birds', birds);
        ```
        
        æ‡‰ç”¨ç¨‹å¼å°±èƒ½å¤ è™•ç†ç™¼çµ¦Â `/birds`å’ŒÂ `/birds/about`Â çš„è¦æ±‚ï¼Œä¸¦ä¸”å‘¼å«è©²è·¯ç”±ç‰¹å®šçš„Â `timeLog`ä¸­ä»‹è»Ÿé«”å‡½æ•¸
        
    
    `Router`å¯¦ä¾‹æ˜¯ä¸€å€‹å®Œæ•´çš„ä¸­ä»‹è»Ÿé«”èˆ‡è·¯ç”±ç³»çµ±ï¼› å› æ­¤ï¼Œå¸¸è¢«ç¨±ç‚ºã€Œè¿·ä½ æ‡‰ç”¨ç¨‹å¼ã€ã€‚
    
    </aside>
    
    Router èµ·æ‰‹å¼ï¼š å¦å¤–å»ºç«‹mini app ç•¶ä½œå¤–æ›å›åŸæœ¬app çš„æ¸ é“ ä¹‹å¾Œåœ¨server.js å–ç”¨
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2013.png)
    

1. å»ºç«‹routerè³‡æ–™å¤¾ å°‡æ‰“api ç›¸é—œçš„app.get(â€™â€™XXX,) ç¨‹å¼æ”¾å…¥ stock.js ä½¿ç”¨express è£¡é¢çš„Routeræ–¹æ³• åŸæœ¬appæ”¹æˆrouter
    
    ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2014.png)
    
1. å›åˆ°server.js è£é¢ é€šçŸ¥åŸæœ¬ express æœ‰å¤–æ›ä¸€å€‹ router å¯å¼•å…¥å–ç”¨ ç”¨app.use()

> å¯ä»¥åŒæ™‚æ•´ç†ç›¸ä¼¼apiç¶²å€ â†’  app.use(â€™/api/1.0/stocksâ€™,stockRouter) ä»£è¡¨æ‰€å¼•ç”¨çš„stockRouter è£¡é¢çš„router.get() éƒ½æ˜¯ä½¿ç”¨/api/1.0/stockçš„å‰ç¶´prefix
> 

// æˆ–æ˜¯æŠŠå…±ç”¨çš„ç¶²å€æŠ½å‡ºä¾†æ”¾åœ¨é€™è£¡
// é€™æ¨£ router è£¡åªéœ€è¦å¯«ä¸ä¸€æ¨£çš„åœ°æ–¹å°±å¯ä»¥äº†

```jsx
// é€šçŸ¥app å¤–æ›ä¸€å€‹router mini-app stock æ¨¡çµ„ å¯ä»¥ç”¨åŒå€‹ç¶²å€/api/1.0/stocks/
let stockRouter = require('./routers/stocks');
app.use('/api/1.0/stocks', stockRouter);
```

> app èƒ½ç”¨çš„åŠŸèƒ½ routerå¤§å¤šéƒ½èƒ½ç”¨ï¼š router.use(), router.get(), router.post()
> 

[[node]expressä¸­app.useå’Œapp.getçš„åŒºåˆ«åŠè§£æ_æ¢§æ¡å’Œé£çš„åšå®¢-CSDNåšå®¢_app.use](https://blog.csdn.net/wthfeng/article/details/53366169)

å¾Œç«¯è³‡æ–™å¤¾çµæ§‹å¦‚ä¸‹åƒè€ƒï¼š

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2015.png)

### è¨»å†ŠåŠŸèƒ½ - å‰ç«¯å‚³é€è¨»å†Šè³‡æ–™

- æ•´ç†è¼¸å…¥çš„è³‡æ–™
    
    
    - ä½¿ç”¨register.js å¢åŠ  useState ç‹€æ…‹ å¯é€éonChangeä¿®æ”¹å…§å®¹
        
        ```jsx
        // æœƒå“¡ç‹€æ…‹ state å¯åˆ†é–‹ ä½†å»ºè­°é¡ä¼¼çš„å¯ä»¥å­˜æˆä¸€å€‹ç‰©ä»¶è™•ç†
          // å¦‚æœæ˜¯ä¸€èˆ¬éç‰©ä»¶çš„stateå¯ä»¥ä½¿ç”¨js åŸç”Ÿå»æ”¹è®Šå€¼ ex onChange/ onClick ... æ›´æ–°setXXX()å³å¯
          // ä½†æ˜¯æŠŠç‰©ä»¶å­˜åœ¨useStateè£é¢ç„¡æ³•æŒ‰æ­¤æ“ä½œ(),éœ€è¦è¤‡è£½æˆä¸€å€‹æ–°ç‰©ä»¶,è¦†è“‹å›å»åŸæœ¬çš„é è¨­å€¼ã€‚
          const [member, setMember] = useState({
            email: 'luis.com',
            name: 'luis',
            password: 'testtest',
            confirmPassword: 'testtest',
            photo: '',
          });
          //const [mail, setMail] = useState('luilui');
        //----------------------------------------------------------------------------------------------//
        <div className="mb-4 text-2xl">
                <label htmlFor="name" className="flex mb-2 w-32">
                  Email
                </label>
                <input
                  className="w-full border-2 border-purple-200 rounded-md h-10 focus:outline-none focus:border-purple-400 px-2"
                  type="text"
                  id="email"
                  name="email"
                  // member.email æ˜¯ react
                  value={member.email}
                  onChange={(e) => {
                    // åŸç”Ÿçš„å…¶å¯¦æœ‰æ”¹è®Š 
                    console.log(e.target.value); //æ˜¯æœ‰å€¼ ä½†ç„¡æ³•è¦†è“‹ éœ€è¦ç”¨setMember() å°‡æ•´å€‹memberè³‡è¨Šè¦†è“‹éå»
                    // ä¸èƒ½ç›´æ¥å»å‹• state -->  
                    // member.email = e.target.value; 
                    // setMember(e.target.value); **// uncontrolled å•é¡Œ**
        
                    è§£æ³•ï¼š          
                    **// æŠŠåŸæœ¬çš„ member è¤‡è£½ä¸€å€‹å‡ºä¾† ä¿®æ”¹è©²ç‰©ä»¶çš„æŸçš„keyå€¼ åœ¨è¦†è“‹å›å»setMember()**
                    let newMember = { ...member };
                    newMember.email = e.target.value;
                    setMember(newMember);
                  }}
                />
              </div>
        
        ```
        
    
    - åŒæ¨£å…§å®¹å¯æ‹‰å‡ºä¾†ç¨ç«‹æˆä¸€å€‹å‡½å¼è™•ç† ç¶å®šåœ¨å°æ‡‰input
        
        > å› ç‚ºinputæ¬„ä½çš„nameå±¬æ€§å…§å®¹å’Œç‰©ä»¶çš„è®Šæ•¸äº‹å…ˆè¨­å®šç›¸åŒæ‰€ä»¥å¯ä»¥åˆ©ç”¨æ­¤é»å–å€¼
        > 
    
    æŠ“å–input çš„æ–‡å­—å…§å®¹ type= name, password,emailâ€¦ æ–‡å­—
    
    ```jsx
    function handleChange(e) {
        console.log('handleChange', e.target.name, e.target.value);
        let newMember = { ...member };
        newMember[e.target.name] = e.target.value;
        setMember(newMember);
    
        // æ¯”è¼ƒæ½®çš„å¯«æ³• ES6 
        **// setMember({ ...member, [e.target.name]: e.target.value });**
      }
    ```
    
    æŠ“å–ä¸Šå‚³æª”æ¡ˆ type= file
    
    ### å‰ç«¯ç¶å®šä¸Šå‚³åœ–ç‰‡çš„åŠŸèƒ½
    
    ```jsx
    function handleUpload(e) {
        // type=file çš„ input
        **// é¸å¥½çš„æª”æ¡ˆæ˜¯æ”¾åœ¨ e.target.files[0]**
        setMember({ ...member, photo: e.target.files[0] });
      }
    ```
    
- å‚³é€çµ¦å¾Œç«¯
    
    æœ‰æ²’æœ‰ä¸Šå‚³åœ–ç‰‡ åšæ³•æœƒä¸åŒï¼š
    
    - æ‰“apié€å›å¾Œç«¯â€”-ç„¡ä¸Šå‚³æª”æ¡ˆä½œæ³•ï¼š
        
        ```jsx
        async function handleSubmit(e) {
            // æŠŠé è¨­è¡Œç‚ºé—œæ‰
            e.preventDefault();
            try {
              // æ–¹æ³•1: æ²’æœ‰åœ–ç‰‡ä¸Šå‚³ã€å–®ç´” post ä¸€å€‹ json ç‰©ä»¶
              let response = await axios.post(`${API_URL}/auth/register`, member);
              console.log(response.data);
            } catch (e) {
              console.error('register', e);
            }
          }
        ```
        
        ç”¨ç‰©ä»¶å‚³åˆ°å¾Œç«¯çš„è³‡æ–™æœƒè¢«æ¨™**Content-Type: application/json** 
        
        ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2016.png)
        
        ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2017.png)
        
        ```jsx
        
        **// server.js** 
        //è‹¥è¦è®“express èªå¾—å‚³å…¥çš„jsonè³‡è¨Š éœ€è¦å†è¨­å®šä¸­é–“ä»¶ å­˜å–è³‡æ–™
        app.use(express.json()); // éœ€è¦æ”¾åœ¨å‚³è¼¸è³‡æ–™çš„æœ€å‰æ–¹ è®“ç¨‹å¼å…ˆè·‘é é †åºå•é¡Œ
        ```
        
        > //è‹¥ä»‹æ„æ•ˆèƒ½å•é¡Œå¯ä»¥../
        //1. å¯«åœ¨router è£¡é¢ ex: router.ues(express.json())
        //2. é‡å°ç‰¹å®šä¸­é–“ä»¶ æ”¾åœ¨è·¯ç”±ä¸­é–“ä»¶ä½¿ç”¨ ex router.post('/api/1.0XXX',express.json(),(req,res,next)=>{}) ä½†å…¶ä»–çš„å°±å‚³ä¸åˆ°json()
        > 
        
    
    - æ‰“apié€å›å¾Œç«¯â€”-**æœ‰ä¸Šå‚³æª”æ¡ˆä½œæ³•**ï¼š
        
        ```jsx
            // æ–¹æ³•2: è¦ä¸Šå‚³åœ–ç‰‡ FormData
              let formData = new FormData();
              formData.append('email', member.email);
              formData.append('name', member.name);
              formData.append('password', member.password);
              formData.append('confirmPassword', member.confirmPassword);
              formData.append('photo', member.photo);
              let response = await axios.post(`${API_URL}/auth/register`, formData);
        ```
        
        ç”¨formData å‚³åˆ°å¾Œç«¯çš„è³‡æ–™æœƒè¢«æ¨™**Content-Type:** multipart/form-data
        
        ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2018.png)
        
        ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2019.png)
        
        express å…§å»ºç„¡æ³•è®€å–form-dataæ ¼å¼ éœ€è¦è¼‰å…¥å¥—ä»¶multer [npm å¥—ä»¶](https://www.notion.so/npm-114585b3aff84212a5f1d753e852aaf0?pvs=21) 
        
        ```jsx
        const multer = require('multer');
        // è¨­å®šåœ–ç‰‡å­˜å…¥ä½ç½®
        const storage = multer.diskStorage({
          **// è¨­å®šå­˜åœ¨ç¡¬ç¢Ÿ**
          // æ‰‹å‹•å»ºç«‹è¨­å®šå­˜åœ¨å“ªå€‹æª”æ¡ˆå¤¾ -> public/upload
          destination: function (req, file, cb) {
            console.log('des,file', file);
            // è¦å®šå¯«æ³•
            // path.join é¿å…ä¸åŒä½œæ¥­ç³»çµ±ä¹‹é–“çš„ / æˆ– \
            // __dirname ç›®å‰æª”æ¡ˆçš„ä½ç½®ï¼Œç”¨ __dirname å°±å¯ä»¥ä¸ç”¨ç®¡æ˜¯åœ¨å“ªè£¡åŸ·è¡Œç¨‹å¼çš„
            cb(null, path.join(__dirname, '..', 'public', 'uploads')); //æ¯”è¼ƒä¿éšª é¿å…ä¸åŒä½œæ¥­ç³»çµ±ä¹‹é–“å·®ç•°
            // cb(null, __dirname + '/../public/uploads'); // å¯ä»¥é€™æ¨£å¯«
          },
          **//åœ–ç‰‡åç¨±**
          filename: function (req, file, cb) {
            console.log('filename', file);
            // file.originalname //åŸå§‹æª”åé€™æ¨£æŠ“ test.png
            const ext = file.originalname.split('.').pop(); //ç”¨split()æ‹†åˆ†å¾Œå–æœ€å¾Œä¸€å€‹å€¼
            cb(null, `member-${Date.now()}.${ext}`); 
            //é‡æ–°å‘½åæª”å member-æ™‚é–“.å‰¯æª”å æˆ–è€…ç”¨uudiå–éš¨æ©Ÿä¸é‡è¤‡çš„äº‚ç¢¼å–å 
          },
        });
        // è¨­å®šæˆä¸­é–“ä»¶
        const uploader = multer({
          // å‚³åˆ°å“ª
          storage: storage,
          // éæ¿¾åœ–ç‰‡ç¨®é¡
          fileFilter: function (req, file, cb) {
            if (
              file.mimetype !== 'image/jpeg' &&
              file.mimetype !== 'image/jpg' &&
              file.mimetype !== 'image/png'
            ) {
              cb(new Error('ä¸Šå‚³çš„æª”æ¡ˆå‹æ…‹ä¸æ¥å—'), false);
            } else {
              cb(null, true);
            }
          },
          // éæ¿¾åœ–ç‰‡å¤§å°
          limits: {
            // 500k
            fileSize: 500 * 1024,
          },
        });
        // åŠ å›ä¸­é–“ä»¶ æ”¾åœ¨é©—è­‰ä¹‹å‰
        router.post(`/api/1.0/auth/register`, **uploader.single('photo'),**registerRules,
          async (req, res, next) => {
        console.log('register', req.body, **req.file**); 
        // å¾Œç«¯æŠ“åˆ°å‰ç«¯ä¾†çš„memberç‰©ä»¶è³‡æ–™ ç”¨req.bodyå–ç”¨
        /*{
          email: '0f1ffff0eeeefe0lfuis@jiji.com',
          name: 'of1offffjennyeeeee',
          password: 'testtest',
          confirmPassword: 'testtest'
        }*/
        // å‰ç«¯ä¾†æª”æ¡ˆè³‡æ–™è¢«æ”¾åœ¨req.fileå–ç”¨
        /*{
          fieldname: 'photo',
          originalname: 'Ã¦\x88ÂªÃ¥\x9C\x96 2022-12-14 Ã¤Â¸\x8BÃ¥\x8D\x881.03.52.png',
          encoding: '7bit',
          mimetype: 'image/png',
          destination: '/Users/liuxueru/Desktop/nextjs workshop/simple-web/stock-be/public/uploads',
          filename: 'member-1671180881463.png',
          path: '/Users/liuxueru/Desktop/nextjs workshop/simple-web/stock-be/public/uploads/member-1671180881463.png',
          size: 255692
        }*/
        //...//
          }
        );
        
        ```
        
    
    [[Node.js]å¯¦ä½œmulteræª”æ¡ˆä¸Šå‚³(äºŒ) - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©](https://ithelp.ithome.com.tw/articles/10231465)
    

- é©—è­‰å‚³éå»çš„è³‡æ–™
    - [x]  ç¢ºèªè³‡æ–™æœ‰æ²’æœ‰æ”¶åˆ°: ä½¿ç”¨Â `express.json`Â ä¸­é–“ä»¶
    
     è³‡æ–™çš„é©—è­‰Â **å¾Œç«¯ä¸å¯ä»¥ç›¸ä¿¡ä¾†è‡ªå‰ç«¯çš„è³‡æ–™(è³‡æ–™é©—è­‰)**
    
    - [x]  æª¢æŸ¥ email æœ‰æ²’æœ‰é‡è¤‡
        - [ ]  å¦‚æœæœ‰ï¼Œå›è¦† 400 è·ŸéŒ¯èª¤è¨Šæ¯
    - [x]  å¯†ç¢¼è¦é›œæ¹Š hash
    - [x]  è³‡æ–™å­˜åˆ°è³‡æ–™åº«
    - [ ]  å›è¦†å‰ç«¯
1. å¯†ç¢¼æª¢æŸ¥
    
    [å¯†ç¢¼å­¸  ****Encodeã€Encrypt è·Ÿ Hash****](https://www.notion.so/Encode-Encrypt-Hash-1c58a0208cb74402b23c31ec71ad936d?pvs=21)
    
    > å¯†ç¢¼é›œæ¹Šé–‹ç™¼åˆæœŸå°±å¿…é ˆæ±ºå®š,ç„¡æ³•ä¸­é€”æ›´æ›æ¼”ç®—æ³•
    > 
    
    ### ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼š [npm å¥—ä»¶](https://www.notion.so/npm-114585b3aff84212a5f1d753e852aaf0?pvs=21)
    
    - md5(é›œæ¹Šï¼‰æ¯æ¬¡é›œæ¹Šçµæœéƒ½ä¸€æ¨£ **å¯ä»¥è¢«åæŸ¥ å½©è™¹è¡¨**
    - bcrypt  -æ¨ ï¼ˆæ¯æ¬¡é›œæ¹Šéƒ½ä¸åŒï¼‰éœ€ç”¨async åŒ…promise ç„¡æ³•è¿”è§£
        
        ```jsx
        const bcrypt = require('bcrypt');
        
        (async () => {
          let result1 = await bcrypt.hash('test', 10);  //æœ€é•·60
        //åƒæ•¸ç¬¬ä¸€å€‹å¯¦éš›å¯†ç¢¼ ç¬¬äºŒå€‹é›œæ¹Šå¾Œçš„å­—å…ƒæ•¸é‡
          console.log('result1:', result1);
          let result2 = await bcrypt.hash('test', 10);
          console.log('result2:', result2);
        })();
        ```
        
    - argon2-  ï¼ˆæ¯æ¬¡é›œæ¹Šéƒ½ä¸åŒï¼‰éœ€ç”¨async åŒ…promise ç„¡æ³•è¿”è§£ å»ºè­°æ–°å°ˆæ¡ˆ
        
        ```jsx
        const argon2 = require('argon2');
        
        (async () => {
          let result3 = await argon2.hash('test', 10);//æœ€é•·96
          console.log('argon2:1', result3);
          let result4 = await argon2.hash('test', 10);
          console.log('argon2:2', result4);
        })();
        ```
        

1. å›è¦†å‰ç«¯
    
    ### **è³‡æ–™é©—è­‰ validator**
    
    [[ç­†è¨˜] æŠŠç© express-validator åœ¨ä¼ºæœå™¨ç«¯åšè¡¨å–®é©—è­‰](https://medium.com/%E9%BA%A5%E5%85%8B%E7%9A%84%E5%8D%8A%E8%B7%AF%E5%87%BA%E5%AE%B6%E7%AD%86%E8%A8%98/%E7%AD%86%E8%A8%98-%E6%8A%8A%E7%8E%A9-express-validator-%E5%9C%A8%E4%BC%BA%E6%9C%8D%E5%99%A8%E7%AB%AF%E5%81%9A%E8%A1%A8%E5%96%AE%E9%A9%97%E8%AD%89-797342aab2d3)
    
    - å‰ç«¯é©—è­‰: UX å¿«é€Ÿåœ°è®“ä½¿ç”¨è€…çŸ¥é“ä»–çš„è¼¸å…¥æœ‰å•é¡Œ (html / jquery éƒ½æœ‰validataå¥—ä»¶)
    - å¾Œç«¯é©—è­‰: ç‚ºäº†è³‡æ–™å®‰å…¨ã€è³‡æ–™ä¹¾æ·¨ (å¾Œç«¯ å¯ä½¿ç”¨express-validator)
    
    > ä½¿ç”¨react æ¡†æ¶ HTMLè¡¨å–®é©—è­‰å¯èƒ½å¤±æ•ˆ
    > 
    
    ### å¼•ç”¨express-validator å¥—ä»¶  [npm å¥—ä»¶](https://www.notion.so/npm-114585b3aff84212a5f1d753e852aaf0?pvs=21)
    
    åœ¨å¾Œç«¯server.js è™•ç†é©—è­‰å‰ç«¯çš„è³‡æ–™
    
    ```jsx
    // npm i express-validator
    const { body, validationResult } = require('express-validator');
    // å¼•å…¥express é©—è­‰ åˆ©ç”¨ä¸­é–“ä»¶æ–¹å¼æª¢æŸ¥
    
    // å¾ body å–å„æ¬„çš„input nameå±¬æ€§å€¼å¥—å…¥å¥—ä»¶è£¡çš„å‡½å¼ä¸¦æ­é…é è¨ˆå›å‚³çš„æ–‡å­—
    const **registerRules** = [
      // ä¸­é–“ä»¶ï¼š æª¢æŸ¥emailæ˜¯å¦åˆæ³•
      body('email').isEmail().withMessage('Emailæ¬„ä½è«‹å¡«å¯«æ­£ç¢ºæ ¼å¼'),
      // ä¸­é–“ä»¶ï¼šæª¢æŸ¥å¯†ç½µé•·åº¦
      body('password').isLength({ min: 8 }).withMessage('å¯†ç¢¼é•·åº¦è‡³å°‘ç‚º8'),
      // ä¸­é–“ä»¶ï¼š æª¢æŸ¥password &confirmed password æ˜¯å¦ä¸€è‡´
      // å®¢è£½custom()ä¸­é–“ä»¶çš„æ¢ä»¶
      body('confirmPassword')
        .custom((value, { req }) => {
          return value === req.body.password;
        })
        .withMessage('å¯†ç¢¼ä¸ä¸€è‡´'),
    ];
    // **registerRules**åŒ…æˆé™£åˆ—ç•¶ä½œä¸­é–“ä»¶æ”¾å…¥
    router.post(`/api/1.0/auth/register`,**registerRules**, async (req, res, next) => {
    // ç•¶è·¯ç”±åŒ¹é…æˆåŠŸé€²å…¥**registerRulesä¸­é–“ä»¶ æœƒå¾—åˆ°req å¾validationResultå–ç”¨req çš„çµæœ**
    
    const validationResult = validationResult(req);
      console.log('validationResult', validateResult);
    **/*validationResult Result {
      formatter: [Function: formatter],
      errors: [
        {
          value: 'luis',
          msg: 'Emailæ¬„ä½è«‹å¡«å¯«æ­£ç¢ºæ ¼å¼',
          param: 'email',
          location: 'body'
        },
        {
          value: 'test',
          msg: 'å¯†ç¢¼é•·åº¦è‡³å°‘ç‚º8',
          param: 'password',
          location: 'body'
        },
        {
          value: 'testtes',
          msg: 'å¯†ç¢¼ä¸ä¸€è‡´',
          param: 'confirmPassword',
          location: 'body'
        }
      ]**
    }*/
    // è‹¥é©—è­‰æˆåŠŸç„¡èª¤ validationResult å–ä¸åˆ°å€¼ é€²å…¥ä¸‹å€‹ä¸­é–“ä»¶  è‹¥æœ‰å€¼ä»£è¡¨é©—è­‰å¤±æ•— å›å‚³å¤±æ•—æç¤º 
      if (!validateResult.isEmpty()) {
        return res.status(400).json({ erros: validateResult.array() });
      }
    //.....
      }
    });
    
    ```
    

1.  ä½¿ç”¨Â `express.json`Â ä¸­é–“ä»¶
    
    ```jsx
    //è‹¥è¦è®“express èªå¾—å‚³å…¥çš„jsonè³‡è¨Š éœ€è¦å†è¨­å®šä¸­é–“ä»¶ å­˜å–è³‡æ–™
    app.use(express.json()); // éœ€è¦æ”¾åœ¨å‚³è¼¸è³‡æ–™çš„æœ€å‰æ–¹ è®“ç¨‹å¼å…ˆè·‘é é †åºå•é¡Œ
    //è‹¥ä»‹æ„æ•ˆèƒ½å•é¡Œå¯ä»¥../
    //1. å¯«åœ¨router è£¡é¢ 
    ex: router.ues(express.json())
    //2. é‡å°ç‰¹å®šä¸­é–“ä»¶ æ”¾åœ¨è·¯ç”±ä¸­é–“ä»¶ä½¿ç”¨ 
    ex: router.post('/api/1.0XXX',express.json(),(req,res,next)=>{}) ä½†å…¶ä»–çš„å°±å‚³ä¸åˆ°json()
    ```
    
2. æª¢æŸ¥ email æœ‰æ²’æœ‰é‡è¤‡
    
    å¦‚æœæœ‰ï¼Œå›è¦† 400 è·ŸéŒ¯èª¤è¨Šæ¯
    
    ```jsx
    router.post(`/api/1.0/auth/register`, async (req, res, next) => {
      console.log('register', req.body); 
      // å¾Œç«¯æŠ“åˆ°å‰ç«¯ä¾†çš„memberç‰©ä»¶è³‡æ–™ ç”¨req.bodyå–ç”¨
      // res.json({}); // æª¢æŸ¥ reså›å‚³çµ¦å¾Œç«¯çš„json è³‡æ–™
      // æ–¹æ³•1 çµ¦DB æª¢æŸ¥ æŠŠemail æ¬„ä½è¨­å®šæˆuniqle(æ•´å¼µè³‡æ–™è¡¨çš„emailä¸å¾—é‡è¤‡)
      // æ–¹æ³•2 å’Œè³‡æ–™åº«æ’ˆæ’ˆçœ‹æ˜¯å¦emailå·²ç¶“å­˜åœ¨,æŠ“åˆ°è®Šæ•¸æ‰“apiæŸ¥æ˜¯å¦æœ‰è³‡æ–™ (æ–¹æ³•1/2å¯ä¸¦è¡Œï¼‰è€—æ•ˆèƒ½
      let [member] = await pool.execute(`SELECT * FROM members WHERE email=?`, [
        req.body.email,
      ]);
      // [data,fields]
      // let data = result[0];
      if (member.length == 0) {
      } else {
      //å¦‚æœæœ‰ï¼Œå›è¦† 400 è·ŸéŒ¯èª¤è¨Šæ¯
        return res.status(400).json({ message: 'æ­¤email å·²ç¶“è¨»å†Šé' });
      }
    });
    ```
    

4.  å­˜è³‡æ–™åº«

```
router.post(`/api/1.0/auth/register`, 
**uploader.single('photo'), //åœ–ç‰‡ä¸Šå‚³**
registerRules, //è³‡æ–™é©—è­‰
async (req, res, next) => {
  // console.log('register', req.body); // å¾Œç«¯æŠ“åˆ°å‰ç«¯ä¾†çš„memberç‰©ä»¶è³‡æ–™ ç”¨req.bodyå–ç”¨
  **//  å»è³‡æ–™åº«æ’ˆæ’ˆçœ‹æ˜¯å¦emailå·²ç¶“å­˜åœ¨**
  let [member] = await pool.execute(`SELECT * FROM members WHERE email=?`, [
    req.body.email,
  ]);

  if (member.length == 0) {
    // åˆæ­¥æª¢æŸ¥æ²’æœ‰é‡è¤‡emailè¨»å†Š æ‰åšä¸‹ä¸€æ­¥
    // å°‡å¯†ç¢¼è³‡æ–™é›œæ¹Šè½‰æ›
    let hashedPassword = await bcrypt.hash(req.body.password, 10);
    **// è³‡æ–™å­˜åˆ°è³‡æ–™åº« 

    // é€£åŒè·¯å¾‘ä¸€èµ·å­˜å…¥è³‡æ–™åº«
    let filename = req.file ? '/uploads/' + req.file.filename : '';
    //TODO:  è³‡æ–™å­˜åˆ°è³‡æ–™åº«
    let result = await pool.execute(
      `INSERT INTO members (email,password,name,photo) VALUES (?,?,?,?)`,
      [req.body.email, hashedPassword, req.body.name, filename]
    );**
    console.log('è¨»å†Šçš„è³‡æ–™', result);// **pool.execute å›å‚³çš†ç‚ºé™£åˆ—**
    //TODO:  å›è¦†å‰ç«¯
    res.json({ message: 'ok! è¨»å†ŠæˆåŠŸ' }); // æª¢æŸ¥ reså›å‚³çµ¦å¾Œç«¯çš„json è³‡æ–™
  } else {
    return res.status(400).json({ message: 'æ­¤email å·²ç¶“è¨»å†Šé' });
  }

 **//æœƒæœ‰ race condition çš„å•é¡Œ**
});
```

[JavaScriptâ€Š-â€Šasync/await çš„ race condition](https://toy9986619.medium.com/javascript-async-await-%E7%9A%84-race-condition-20927705569)

[Day15 - node.jsä½¿ç”¨éœæ…‹æª”æ¡ˆæœå‹™ - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©](https://ithelp.ithome.com.tw/articles/10186000)

- ** ç‚ºæª”æ¡ˆè£½ä½œéœæ…‹æœå‹™ Express è¨—ç®¡éœæ…‹æª”æ¡ˆ
    
    é€šé Express å…§å»ºçš„ express.static å¯ä»¥æ–¹ä¾¿åœ°è¨—ç®¡éœæ…‹æª”æ¡ˆï¼Œä¾‹å¦‚åœ–ç‰‡ã€CSSã€JavaScript æª”æ¡ˆç­‰ã€‚
    
    å°‡éœæ…‹è³‡åŸå§‹æª”æ‰€åœ¨çš„ç›®éŒ„ä½œç‚ºå¼•æ•¸å‚³éçµ¦ express.static ä¸­ä»‹è»Ÿé«”å°±å¯ä»¥æä¾›éœæ…‹è³‡åŸå§‹æª”çš„è¨ªå•äº†ã€‚ä¾‹å¦‚ï¼Œå‡è¨­åœ¨ public ç›®éŒ„æ”¾ç½®äº†åœ–ç‰‡ã€CSS å’Œ JavaScript æª”æ¡ˆï¼Œä½ å°±å¯ä»¥ï¼š
    
    ```jsx
    app.use(express.static('public'));
    ```
    
    ç¾åœ¨ï¼Œpublic ç›®éŒ„ä¸‹é¢çš„æª”æ¡ˆå°±å¯ä»¥è¨ªå•äº†ã€‚
    
    `http://localhost:3000/images/kitten.jpg
    http://localhost:3000/css/style.css
    http://localhost:3000/js/app.js
    http://localhost:3000/images/bg.png
    http://localhost:3000/hello.html`
    
    æ‰€æœ‰æª”æ¡ˆçš„è·¯å¾‘éƒ½æ˜¯ç›¸å°æ–¼å­˜æ”¾ç›®éŒ„çš„ï¼Œå› æ­¤ï¼Œå­˜æ”¾éœæ…‹æª”æ¡ˆçš„ç›®éŒ„åä¸æœƒå‡ºç¾åœ¨ URL ä¸­ã€‚
    
    å¦‚æœä½ çš„éœæ…‹è³‡æºå­˜æ”¾åœ¨å¤šå€‹ç›®éŒ„ä¸‹é¢ï¼Œä½ å¯ä»¥å¤šæ¬¡å‘¼å« express.static ä¸­ä»‹è»Ÿé«”ï¼š
    
    ### è™›æ“¬è·¯å¾‘
    
    å¦‚æœå¸Œæœ›æ‰€æœ‰é€šé express.static è¨ªå•çš„æª”æ¡ˆéƒ½å­˜æ”¾åœ¨ä¸€å€‹â€œè™›æ“¬ï¼ˆvirtualï¼‰â€ç›®éŒ„ï¼ˆå³ç›®éŒ„æ ¹æœ¬ä¸å­˜åœ¨ï¼‰ä¸‹é¢ï¼Œå¯ä»¥é€šéç‚ºéœæ…‹è³‡æºç›®éŒ„[æŒ‡å®šä¸€å€‹æ›è¼‰è·¯å¾‘](http://www.expressjs.com.cn/4x/api.html#app.use)çš„æ–¹å¼ä¾†å¯¦ç¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ```jsx
    app.use('/static', express.static('public'));
    ```
    
    ç¾åœ¨ï¼Œä½ å°±å¯ä»¥é€šéå¸¶æœ‰ â€œ/staticâ€ å­—é¦–çš„åœ°å€ä¾†è¨ªå• public ç›®éŒ„ä¸‹é¢çš„æª”æ¡ˆäº†
    
    `http://localhost:3000/static/images/kitten.jpg
    http://localhost:3000/static/css/style.css
    http://localhost:3000/static/js/app.js
    http://localhost:3000/static/images/bg.png
    http://localhost:3000/static/hello.html`
    

```jsx
//è¨­ç½®éœæ…‹æª”æ¡ˆ
// express.static => è®“éœæ…‹æª”æ¡ˆå¯ä»¥æœ‰ç¶²å€
// http://localhost:3002/uploads/æª”æ¡ˆåç¨±
app.use(express.static(path.join(__dirname, 'public')));
// æˆ–æ˜¯çµ¦ prefix
// http://localhost:3002/public/uploads/æª”æ¡ˆåç¨±
// è™›æ“¬è·¯å¾‘
// app.use('/public', express.static(path.join(__dirname, 'public')));
```

### ç™»å…¥ç™»å‡ºåŠŸèƒ½ -æ¯”å°å‰ç«¯è³‡æ–™ ç¶²ç«™ç™»å…¥ç‹€æ…‹ ç™»å‡ºç‹€æ…‹

1. æ¯”å°å‰ç«¯è³‡æ–™
    
    ```jsx
    router.post(`/api/1.0/auth/login`, async (req, res, next) => {
      // æŠ“å–ç™»å…¥è³‡æ–™
      **//TODO æ˜¯å¦åšè³‡æ–™é©—è­‰ å¯ä¸åš ï¼ˆå› ç‚ºè¨»å†Šå·²ç¶“æœ‰æŠŠé—œäº†ï¼‰**
      //TODO æ˜¯å¦emailæœ‰è¨»å†Šé å¦‚æœæ²’æœ‰è¨»å†Šé å›è¦†400
      console.log('login data', req.body);
      try {
        let [members] = await pool.execute(`SELECT * FROM members WHERE email=?`, [
          req.body.email,
        ]);
        // åˆæ­¥æª¢æŸ¥æ²’æœ‰é‡è¤‡è¨»å†Š æ‰åšä¸‹ä¸€æ­¥
        if (members.length == 0) {
          // å¦‚æœç­‰æ–¼0 ä»£è¡¨æ²’æœ‰è³‡æ–™
          return res.status(400).json({ message: 'å¯†ç¢¼æˆ–emailéŒ¯èª¤' }); //éŒ¯èª¤è¨Šæ¯ä¸èƒ½å¯«å¤ªæ˜ç¢ºçµ¦é§­å®¢æ©Ÿæœƒ
        }
        let member = members[0];
        // å¯†ç¢¼æ¯”è¼ƒ
        //TODO å¦‚æœå¯†ç¢¼ä¸å° å›è¦† 401
        let compareResult = await bcrypt.compare(
          req.body.password,
          member.password
        ); **// å› ç‚ºå¯†ç¢¼æ˜¯ç”¨bcrypt é›œæ¹Šå­˜å…¥ éœ€ä½¿ç”¨bcrypt.compare æ¯”è¼ƒæ˜¯å¦ç›¸åŒ å›è¦†true or false**
        if (!compareResult) {
          return res.status(401).json({ message: 'å¯†ç¢¼æˆ–emailéŒ¯èª¤' });
        }
        res.json({ message: 'ç™»å…¥æˆåŠŸ' });
    
        //  **å¦‚æœå¯†ç¢¼æ­£ç¢º ä¿®æ”¹ç‹€æ…‹ç™»å…¥æˆåŠŸ 1. jwt token 2. session/cookie -->ä¸‹ä¸€æ­¥é©Ÿ**
      } catch (e) {
        console.error(e);
      }
    });
    ```
    
2. ç¢ºèªå¯†ç¢¼æ­£ç¢ºè¨­å®šsession å›ç€è¦½å™¨çš„cookie

[session vs cookie ](https://www.notion.so/session-vs-cookie-0dd49a04963c4d84a87d987852b10b05?pvs=21) [JWT token TBA](https://www.notion.so/JWT-token-TBA-03b655d759354c779c3aad7742924976?pvs=21) 

### è¼‰å…¥å¥—ä»¶ express-session [npm å¥—ä»¶](https://www.notion.so/npm-114585b3aff84212a5f1d753e852aaf0?pvs=21)

é è¨­å­˜åœ¨è¨˜æ†¶é«” ä½†nodejs é‡é–‹æœƒé‡‹æ”¾è¨˜æ†¶é«”ç©ºé–“session å°±æœƒä¸è¦‹

<aside>
â˜ğŸ» session è¦æœ‰åœ°æ–¹å­˜: **è¨˜æ†¶é«”ã€ç¡¬ç¢Ÿã€è³‡æ–™åº«**

ç·´ç¿’æ™‚å­˜ç¡¬ç¢Ÿå°±å¯ä»¥äº†

**æ‰€ä»¥æ¥­ç•Œå¸¸ç”¨å­˜åœ¨ç¡¬ç¢Ÿ è®€å–è¼ƒæ…¢â†’ connect-redis â€”>æ¥­ç•Œå¸¸ç”¨ (éœ€è¼‰å¥—ä»¶ï¼‰**

**é–‹ç™¼ç”¨å­˜åœ¨æª”æ¡ˆ æ“´å……è¼ƒå·® â†’session-file-store ï¼ˆéœ€è¼‰å¥—ä»¶ï¼‰**

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2020.png)

</aside>

```jsx
// server.js
// å•Ÿç”¨session
const FileStore = require('session-file-store')(expressSession);
// å•Ÿç”¨session
const expressSession = require('express-session');
// session å­˜å…¥åœ°æ–¹çš„é…ç½® session-file-store æŠŠsession å­˜åœ¨ç¡¬ç¢Ÿä¸­
const FileStore = require('session-file-store')(expressSession);
//ç•¶ä½œä¸­é–“ä»¶ä½¿ç”¨;
app.use(
  expressSession({
    // è¨­å®šå­˜å…¥çš„åœ°æ–¹
    store: new FileStore({
      // è¨­å®šsessionè·¯å¾‘
      path: path.join(__dirname, '..', 'sessions'),
    }),
    // è¨­å®šåŠ å¯†å¯†ç¢¼ åƒè¬ä¸è¦å¯« ç”¨è®Šæ•¸å­˜æ©Ÿæ•è³‡æ–™
    secret: process.env.SESSION_SECRET,
    // å¦‚æœsession æ²’æœ‰æ”¹è®Šæ˜¯å¦è¦é‡æ–°å„²å­˜
    resave: false,
    // é‚„æ²’åˆå§‹åŒ–çš„ æœªç™»å…¥çš„è³‡æ–™ è¦ä¸è¦å­˜æˆsession?
    saveUninitialized: false,
  })
);
```

> æ³¨æ„æ ¼å¼å‹¿éŒ¯ å¦å‰‡å¾ˆé›£é™¤éŒ¯
> 

```jsx
// server.js 

const corsOptions = {
  // // å¦‚æœè¦è®“ cookie å¯ä»¥è·¨ç¶²åŸŸå­˜å–ï¼Œé€™é‚Šè¦è¨­å®š credentials
  // // ä¸” origin ä¹Ÿè¦è¨­å®š
   credentials: true,
   origin: ['http://localhost:3000'],
};
app.use(cors(corsOptions));
```

> å¯ä½¿ç”¨useContex() react hook å…¨ç«™æŸ¥è©¢æ˜¯å¦å·²ç™»å…¥ç‹€æ…‹
> 

```jsx
// auth.js
router.post(`/api/1.0/auth/login`, async (req, res, next) => {
  // æŠ“å–ç™»å…¥è³‡æ–™
  **//TODO æ˜¯å¦åšè³‡æ–™é©—è­‰ å¯ä¸åš ï¼ˆå› ç‚ºè¨»å†Šå·²ç¶“æœ‰æŠŠé—œäº†ï¼‰**
  //TODO æ˜¯å¦emailæœ‰è¨»å†Šé å¦‚æœæ²’æœ‰è¨»å†Šé å›è¦†400
  console.log('login data', req.body);
  try {
 //.//
    // å¦‚æœå¯†ç¢¼æ­£ç¢º ä¿®æ”¹ç‹€æ…‹ç™»å…¥æˆåŠŸ  -->å­˜å…¥session
    let saveMember = {
      id: member.id,
      name: member.name,
      email: member.email,
      photo: member.photo,
    };
    // æŠŠè³‡æ–™å¯«é€²å» session è£¡é¢
    **req.session.member = saveMember;
// å°‡æœƒå“¡è³‡æ–™è¨­é€²å»session.member å¦‚æœsession.member æœ‰å€¼å‰‡ä»£è¡¨ç™»å…¥ç‹€æ…‹**
    // å›è¦†å‰ç«¯ å¯ä»¥æ‹¿å»çµ¦å‰ç«¯æ¸²æŸ“ç”¨
    res.json(saveMember);

  } catch (e) {
    console.error(e);
  }
});

// è£½ä½œç™»å‡ºapi
router.get('/api/1.0/auth/logout', (req, res, next) => {
  res.json({ message: 'ç™»å‡ºæˆåŠŸ' });
});
```

å‰ç«¯login.jsæŠ“è³‡æ–™çš„æ™‚å€™ ä¹Ÿéœ€è¦è¨­å®š **withCredentials: true(axios)**   

**åªè¦éœ€è¦åˆ¤æ–·æ˜¯å¦ç™»å…¥è·¨æºå•é¡Œå°±éœ€è¦åŠ ä¸Š**

```jsx
// front-end login.js
async function handleSubmit(e) {
    e.preventDefault();
    let response = await axios.post(`${API_URL}/auth/login`, loginMember, {
      // ç‚ºäº†å¯ä»¥è·¨æºå­˜å– cookie
      withCredentials: true, 
    });
    console.log(response.data);
    // å‘Šè¨´ auth context æœƒå“¡æœ‰è³‡æ–™åš•
    setMember(response.data);
    setIsLogin(true);
  }
 // front-end Navbar - logout.js
async function handleLogout() {
    let response = await axios.get(`${API_URL}/auth/logout`, {
      **withCredentials: true,**
    });
    console.log(response.data);
    setMember(null);
  }
```

### useContext() ç”¨æ³•è£œå…… å…¨ç«™å–ç”¨useState() [useHook](https://www.notion.so/useHook-9f90926d758b4c67b43bfbc3b39482c9?pvs=21)

é€šå¸¸useState()åªå­˜åœ¨æ–¼è©²componentç•¶ä¸­ å¦‚æœæœ‰å…¨ç«™éƒ½éœ€è¦æŸ¥æ‰¾ é™¤äº†props å°‡å€¼å¾€ä¸‹å‚³ é‚„å¯ä»¥ä½¿ç”¨useContext() 

**æ­¤ç”¨æ³•é‚„å¯ä»¥æ›´æ·±å…¥ä¸‹ä¸€å±¤å–ç”¨ï¼´ï¼¢ï¼¡**

åŸºæœ¬ç”¨æ³•ï¼šåœ¨æ­¤æ¬¡ç·´ç¿’ç•¶ä¸­ å°‡è¨­å®šå…¨ç«™éƒ½èƒ½æŸ¥æ‰¾ ç™»å…¥ç‹€æ…‹å–ç”¨

1. å¾Œç«¯å»ºç«‹æŸ¥è©¢ç™»å…¥ç‹€æ…‹çš„router, member.js è®“å‰ç«¯app.jså¯ä»¥æ‰“apiå›æŸ¥ç™»å…¥ç‹€æ…‹
    
    ```jsx
    // member.js
    const express = require('express');
    const router = express.Router();
    
    router.get('/', (req, res, next) => {
      // åˆ¤æ–·é€™å€‹äººæ˜¯å¦å·²ç¶“ç™»å…¥
      //  session è£¡é¢å¦‚æœæ²’æœ‰member è³‡æ–™
      if (!req.session.member) {
        //ä»£è¡¨å°šæœªç™»å…¥ **å›å‚³401 æœªæˆæ¬Šè€Œæ‹’çµ•å­˜å–**
        return res.status(401).json({ message: 'å°šæœªç™»å…¥' });
      }
      // æ–¹æ³•1 æ ¹æ“šsession ä¸­å„²å­˜çš„member id å»æ’ˆè³‡æ–™åº«å°‡æœƒå“¡è³‡æ–™å›çµ¦å‰ç«¯
      //      å„ªé»ï¼šè³‡æ–™æ¯”è¼ƒå³æ™‚æ­£ç¢º
      //      ç¼ºé»ï¼šä¸€ç›´å»å­˜å–è³‡æ–™åº«
      // æ–¹æ³•2 å¯ä»¥ç›´æ¥å›è¦†sessionçš„è³‡æ–™
      // BUT  å¦‚æœæœ‰æä¾›æœƒå“¡ä¿®æ”¹è³‡æ–™çš„åŠŸèƒ½ æ›´æ–°æˆåŠŸå¾Œè¦æ›´æ–°session è³‡æ–™
      res.json(req.session.member);
    });
    
    module.exports = router;
    ```
    

1. å‰ç«¯é–‹æ–°è³‡æ–™å¤¾ context å»ºç«‹ auth.js æª”æ¡ˆ
    
    ```jsx
    // auth.js
    
    import { createContext, useContext } from 'react';
    
    // å»ºç«‹å¯ä»¥å­˜æ”¾useState è³‡è¨Šçš„å®¹å™¨
    export const AuthContext = createContext();
    
    // export æˆuseAuth()å–ç”¨
    export function useAuth() {
      return useContext(AuthContext);
    }
    ```
    

1. åœ¨å…¨ç«™æœ€å¤–å±¤ app.js ä½¿ç”¨æŸ¥æ‰¾  æœƒå“¡è³‡è¨Š
    
    ```jsx
    // app.js 
    // å¼•å…¥å·¦æ–¹å»ºç«‹çš„auth.js å®¹å™¨è³‡æ–™
    import { AuthContext } from './context/auth';
    
    const [member, setMember] = useState(null);
    
      useEffect(() => {
        // å»è¦è¦çœ‹æœ‰æ²’æœ‰æœƒå“¡è³‡æ–™ï¼Œæœ‰è¦åˆ°å°±æ˜¯å·²ç¶“ç™»å…¥é ->å…¨ç«™éƒ½é©ç”¨æª¢æŸ¥
        let getMember = async () => {
          console.log('in APP: check if login');
          let response = await axios.get(`${API_URL}/member`, {
            withCredentials: true,
          });
          setMember(response.data);
        };
        getMember();
      }, []);
    
    // ä¸‹æ–¹app å…¨ç«™çš„å…ƒä»¶åŒ…åœ¨æœ€å¤–å±¤ æŠŠ{member, setMemeber} é€™å…©å€‹è¨­æˆvalue çµ¦ä¸‹é¢å…ƒä»¶å–ç”¨
    return (
        **<AuthContext.Provider value={{ member, setMember }}>**
          <BrowserRouter>
            <Navbar />
            <Routes>
              <Route path="/" exact element={<Stock />} />
              <Route path="/about" element={<About />} />
              <Route path="/login" element={<Login />} />
              <Route path="/register" element={<Register />} />
              <Route path="/stock/:stockId" element={<StockDetails />}>
                {/* <Route path=":currentPage" element={<StockDetails />} /> */}
              </Route>
              <Route path="*" element={<NotFound />} />
            </Routes>
          </BrowserRouter>
        **</AuthContext.Provider>**
      );
    ```
    
    [express éŒ¯èª¤è™•ç†](https://www.notion.so/express-903da75fae2846e2b07b28100aa93271?pvs=21) 
    
    ```
    // å‰é¢çš„ä¸­é–“ä»¶
     app.use((req, res, next) => {
       console.log('é€™è£¡æ˜¯éŒ¯èª¤é ä¹‹å‰çš„ middleware');
       // next å¦‚æœæ˜¯è¦å»ä¸‹ä¸€å€‹ä¸­é–“ä»¶ï¼Œå°±ä¸è¦æ”¾ä»»ä½•åƒæ•¸
       next();
       // next å¦‚æœæ˜¯æƒ³è¦ç›´æ¥è·³å»éŒ¯èª¤è™•ç†ä¸­é–“ä»¶ -> åŠ ä¸Šä»»ä½•åƒæ•¸
       // next(123);
      });
    //test error!!
    app.get('/err', (req, res, next) => {
      throw new Error('æ•…æ„éŒ¯èª¤ä¸Ÿå‡ºä¾†');
      // res.json({ message: 'æ•…æ„éŒ¯èª¤' });
    });
    
    // å‹™å¿…è¦è¨­å®šä¸­é–“ä»¶éŒ¯èª¤è™•ç† å¦å‰‡éŒ¯èª¤è¨Šæ¯æœƒè·‘å‡ºä¾†çµ¦ä½¿ç”¨è€…çœ‹åˆ°
    app.use((err, req, res, next) => {
      console.error('ä¾†è‡ªå››å€‹åƒæ•¸çš„éŒ¯èª¤ä¸­é–“ä»¶', err);
      console.error('æŸ¥æ‰¾å“ªå€‹è·¯ç”±éŒ¯èª¤', req.path);
      res.status(500).json({ message: 'è«‹æ´½ç³»çµ±ç®¡ç†å“¡' });
    });
    ```
    

1. å‰ç«¯appåº•ä¸‹çš„å…ƒä»¶å–ç”¨ ç¯„ä¾‹ ï¼š login.js/ navbar.js/about.js
    
    ```jsx
    // login.js
    
    // æŠŠ member, setMember å¾ auth context è£¡é ­æ‹¿å‡ºä¾†
      const { member, setMember } = useAuth();
    // å¦‚æœapi ç™»å…¥æˆåŠŸ æŠŠ app æŸ¥æ‰¾åˆ°çš„è³‡æ–™ æ›´æ–°æ¸²æŸ“
    async function handleSubmit(e) {
        e.preventDefault();
        let response = await axios.post(`${API_URL}/auth/login`, loginMember, {
          // ç‚ºäº†å¯ä»¥è·¨æºå­˜å– cookie
          withCredentials: true,
        });
        console.log(response.data);
        // å‘Šè¨´ auth context æœƒå“¡æœ‰è³‡æ–™åš•
        setMember(response.data);
        setIsLogin(true);
      }
    ```
    
    ```jsx
    // navbar.js 
    // æŠŠ member, setMember å¾ auth context è£¡é ­æ‹¿å‡ºä¾†
      const { member, setMember } = useAuth();
    // å¦‚æœåŸ·è¡Œ handleLogout å‰‡ æ¸…ç©ºmember è³‡æ–™ ï¼ˆç™»å‡ºï¼‰
    async function handleLogout() {
        let response = await axios.get(`${API_URL}/auth/logout`, {
          withCredentials: true,
        });
        console.log(response.data);
        setMember(null);
      }
    ```
    
    ```jsx
    // about.js
    // æŠŠ member, setMember å¾ auth context è£¡é ­æ‹¿å‡ºä¾†
      const { member, setMember } = useAuth();
    // å¦‚æœæœ‰å€¼ ä»£è¡¨ç™»å…¥ é¡¯ç¤ºå°æ‡‰è³‡æ–™ / å¦‚æœæ²’æœ‰å€¼ ä»£è¡¨ç™»å‡º navigateè·³å›ç™»å…¥ç•«é¢
      if (!member) {
        return <Navigate to="/login" />;
      }
      **// å¦‚æœå¾ context è£¡é¢æ‹¿ï¼Œé€™è£¡å°±ä¸ç”¨è‡ªå·±å†å»è¦ä¸€æ¬¡ åœ¨app.js å·²ç¶“æœ‰å¯«éä¸€æ¨¡ä¸€æ¨£çš„code
      // const [member, setMember] = useState(null);
      // useEffect(() => {
      //   let getMember = async () => {
      //     let response = await axios.get(`${API_URL}/member`, {
      //       withCredentials: true,
      //     });
      //     setMember(response.data);
      //   };
      //   getMember();
      // }, []);**
    ```
    

## è£œå……

### A || B

```jsx
  A || B (A æˆ– B) 

const port = process.env.SERVER_PORT || 3002;

ç¨‹å¼æœƒå…ˆåµæ¸¬ï¼¡æ˜¯å¦ç‚ºtrue / false 
è‹¥ç‚º true å‰‡ä¸æœƒç¹¼çºŒåµæ¸¬
è‹¥ç‚º false å‰‡å¾€ä¸‹åµæ¸¬ï¼¢æ˜¯å¦ç‚º true
å¯ä»¥æ‹¿ä¾†ç•¶é è¨­å€¼çš„æ¦‚å¿µ
 
```

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2021.png)

### ****Express.js req.params ç”¨æ³•****

**express å¯è—‰ç”±è·¯ç”±åµæ¸¬å–å€¼(å¾Œç«¯ä¼ºæœå™¨ï¼‰**

è‹¥å‰ç«¯react æ¡†æ¶è¦æŠ“url å–å€¼å‰‡å¯ä½¿ç”¨useParam();

[å¾Œç«¯expressè·¯ç”± å¾req.queryå–å€¼åŠé‹ç®—](https://medium.com/@aaa24295234/%E5%BE%8C%E7%AB%AFexpress%E8%B7%AF%E7%94%B1-%E5%BE%9Ereq-query%E5%8F%96%E5%80%BC%E5%8F%8A%E9%81%8B%E7%AE%97-77101d9abe18)

[[Express.js]å–å¾—ç¶²é åƒæ•¸çš„ä¸‰ç¨®æ–¹æ³•](https://medium.com/ling-ni-lee/express-js-%E5%8F%96%E5%BE%97%E7%B6%B2%E9%A0%81%E5%8F%83%E6%95%B8%E7%9A%84%E4%B8%89%E7%A8%AE%E6%96%B9%E6%B3%95-39725d8f3211)

<aside>
ğŸ‘‰ğŸ» req.params

ç•¶é€£åˆ°http://localhost/:here ç¶²å€æ™‚ï¼Œ:hereç‚ºå‹•æ…‹è·¯ç”±ï¼Œæœƒæ ¹æ“šå‹•æ…‹è·¯ç”±æ‰€ç”¢ç”Ÿä¸åŒçš„ç¶²å€è€Œå›å‚³ä¸åŒçš„è³‡æ–™

```jsx
 app.get(â€˜/user/:idâ€™, function(req, res){
res.send(â€˜user â€˜ + req.params.id);
});
// è¼¸å…¥localhost:3000/user/123456ï¼Œæœƒå¾—åˆ°user123456ã€‚**idé‚„å¯ä»¥æ›´æ›ç‚ºä»»æ„å€¼ (è®Šæ•¸ï¼‰ã€‚**
```

</aside>

<aside>
ğŸ‘‰ğŸ» req.query

ç”¨ä¾†å–å¾—ç¶²é æœå°‹æ¬„è¼¸å…¥çš„è³‡æ–™ï¼Œæœå°‹è³‡æ–™çš„å›å‚³ç”±formè¡¨å–®å–å¾—

ç•¶è¼¸å…¥localhost:3000/user?abc=123ï¼Œä½¿ç”¨req.query.abcï¼Œå°±èƒ½å–å‡º123ã€‚

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2022.png)

</aside>

<aside>
ğŸ‘‰ğŸ» req.body

req.bodyç”¨ä¾†å–çš„POSTè¡¨å–®é€å‡ºçš„è³‡æ–™ï¼Œä½¿ç”¨ä¸Šéœ€å†å®‰è£ä¸€å€‹middleware ã€Œ*body-parser*ã€

è¼‰å…¥body-parser moduleå¾Œï¼Œéœ€è¨­å®šå¾POSTè¡¨å–®æˆ–å–çš„URLåŠ å¯†è³‡æ–™ï¼Œ**å°‡å®ƒå±•é–‹ç‚ºobjectè³‡æ–™å‹æ…‹**ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚

> ä¹Ÿå¯æŠ“å–å¾å‰ç«¯ä¾†çš„è³‡æ–™ï¼ˆå‰ç«¯åœ¨axios è£¡é¢ç”¨post æ–¹æ³•å°‡è®Šæ•¸å­˜æˆç‰©ä»¶ å‚³å›å¾Œç«¯ï¼‰
> 
> 
> ![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2023.png)
> 

<aside>
ğŸ‘‰ğŸ» ä½¿ç”¨<input type=â€checkboxâ€ name=â€testâ€>ï¼Œå¾Œç«¯å–å¾—æ–¹å¼ï¼šreq.bodyï¼Œnameå‰‡ç‚ºreq.bodyçš„keyè³‡æ–™ï¼Œè‹¥å‹¾é¸å‰‡é¡¯ç¤ºâ€onâ€ï¼Œç„¡å‹¾é¸å‰‡ä¸å­˜åœ¨æ­¤è³‡æ–™

Exampleï¼šè‹¥ç¶²é å­˜åœ¨ä¸‰å€‹checkboxè¡¨å–®

```html
<form>
 <input type=â€textâ€ name=â€wordâ€> æ–‡å­—
 <input type=â€checkboxâ€ name=â€test1â€> vï¼ˆå‹¾é¸ï¼‰
 <input type=â€checkboxâ€ name=â€test2â€> vï¼ˆå‹¾é¸ï¼‰
 <input type=â€checkboxâ€ name=â€test3â€>
</form>
```

ä½¿ç”¨body-parserå–å¾—è³‡æ–™

```json
req.body{
word:'æ–‡å­—',
test1:"on",
test2:"on"
}
```

</aside>

<aside>
ğŸ‘‰ğŸ» ä½¿ç”¨<input type=â€radioâ€ name=â€groupâ€ value=â€test1â€>ï¼Œå¾Œç«¯å–å¾—æ–¹å¼ï¼šreq.bodyï¼Œvalueå‰‡ç‚ºreq.bodyçš„keyè³‡æ–™ï¼Œè‹¥å‹¾é¸å‰‡é¡¯ç¤ºâ€onâ€ï¼Œç„¡å‹¾é¸å‰‡ä¸å­˜åœ¨æ­¤è³‡æ–™ï¼Œradioé¸å–®ä¸­ï¼Œè‹¥nameç›¸åŒï¼Œåœ¨åŒä¸€groupåªå¯å‹¾é¸1å€‹checkã€‚

Exampleï¼šè‹¥ç¶²é å­˜åœ¨ä¸‰å€‹radioè¡¨å–®

```html
<form>
 <input type=â€radioâ€ name=â€groupâ€ value="test1"> vï¼ˆå‹¾é¸ï¼‰
 <input type=â€radioâ€ name=â€groupâ€ value="test1">
 <input type=â€radioâ€ name=â€groupâ€ value="test1">
</form>
```

ä½¿ç”¨req.bodyå–å¾—è³‡æ–™ï¼Œ

```json
req.body{
group:"test1"
}
```

</aside>

</aside>

![Untitled](%E5%BB%BA%E7%AB%8B%E4%BC%BA%E6%9C%8D%E5%99%A8%20simple%20web%20%E5%89%8D%E5%BE%8C%E7%AB%AF%E4%BA%92%E5%8B%95%20533583c06c814cabbb8ab5e160622359/Untitled%2024.png)

### javascript æ•¸å­¸è¨ˆç®—

```jsx
Math.ceil(); //ç„¡æ¢ä»¶é€²ä½
Math.floor(); //ç„¡æ¢ä»¶æ¨å»
```